<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Character Review System - Cloud Sync</title>
    <link rel="stylesheet" href="../../assets/css/nav-global.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

   <style>
    
    :root {
        /* ä¸»è‰²è°ƒï¼šæ¸…çˆ½æµ·æ´‹è“ç»¿ï¼ˆçº¯è‰²ï¼æ— æ¸å˜ï¼‰ */
        --primary: #00acc1;      /* ä¸»è“ç»¿ cyan-600 */
        --primary-dark: #0589aa; /* æ·±è“ç»¿ cyan-900 */
        --primary-light: #b2ebf2; /* æµ…è“ç»¿ cyan-300ï¼ˆç”¨äºæµ…èƒŒæ™¯ï¼‰ */
        
        /* è¾…åŠ©è‰² */
        --success: #4caf50;
        --danger: #ef4444;
        
        /* ä¸­æ€§è‰² */
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --bg-page: #ffffff;       /* çº¯ç™½ä¸»èƒŒæ™¯ */
        --bg-card: #ffffff;
        --bg-hover: #f0fdfd;      /* ææµ…è“ç»¿æ‚¬åœ */
        --bg-light: #ecfdfd;      /* æµ…è“ç»¿èƒŒæ™¯å— */
        --border: #b2ebf2;
        --shadow: rgba(0, 105, 115, 0.12);
        
/* Leitner ç›’å­çº¯è‰²ï¼ˆæ— æ¸å˜ï¼‰ */
--forgot: #ef4444;
--hard: #d97706;
--good: #059669;
--easy: #0891b2;

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
    body { background: linear-gradient(135deg, #f0f9fa 0%, #e0f7fa 100%); color: var(--text-primary); min-height: 100vh; }

    /* Top Navigation styles are now in nav-global.css */

    .container {
        max-width: 1000px;
        margin: 20px auto;
        background: var(--bg-card);
        border-radius: 20px;
        box-shadow: 0 10px 40px var(--shadow);
        padding: 24px;
        border: 1px solid #e0f7fa;
    }

    @media (max-width: 640px) {
        .container {
            margin: 10px;
            padding: 16px;
            border-radius: 16px;
        }
    }

    /* ==================== Header ==================== */
    header { text-align: center; margin-bottom: 32px; }
    h1 { color: var(--primary-dark); font-size: 2.3rem; font-weight: 700; margin-bottom: 8px; }
    .subtitle { color: var(--text-secondary); font-size: 1.1rem; }

    @media (max-width: 640px) {
        header { margin-bottom: 20px; }
        h1 { font-size: 1.6rem; }
        .subtitle { font-size: 0.95rem; }
    }
    
    .device-code-display {
        margin-top: 20px;
        padding: 16px 24px;
        background: var(--bg-light);
        border-radius: 14px;
        display: inline-block;
        border: 1px solid var(--border);
        min-width: 280px;
    }
    .device-code-display strong {
        color: var(--primary);
        font-size: 1.8rem;
        letter-spacing: 4px;
        font-weight: bold;
    }

    @media (max-width: 640px) {
        .device-code-display {
            min-width: auto;
            padding: 12px 16px;
        }
        .device-code-display strong {
            font-size: 1.3rem;
            letter-spacing: 2px;
        }
    }

    /* ==================== Loading ==================== */
    .loader {
        border: 5px solid #f0f7fa;
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        width: 50px; height: 50px;
        animation: spin 1s linear infinite;
        margin: 40px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ==================== Tab System ==================== */
    .tab-system { margin: 24px 0; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px var(--shadow); }
    .tab-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; background: var(--bg-light); }
    .tab-btn {
        padding: 18px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
    }
    .tab-btn:hover { background: rgba(0,172,193,0.15); color: var(--primary); }
    .tab-btn.active { color: var(--primary); background: white; }
    .tab-btn.active::after {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
        background: var(--primary);
    }

    @media (max-width: 640px) {
        .tab-system { margin: 16px 0; }
        .tab-btn {
            padding: 14px 8px;
            font-size: 0.95rem;
        }
    }

    /* ==================== Lesson Selection ==================== */
   /* ==================== Lesson Selection - Modern Card Style (æ–¹æ¡ˆ C) ==================== */
.lesson-selector {
    background: transparent;
    box-shadow: none;
    border: none;
    padding: 0;
    margin: 32px 0;
}

.selector-header {
    background: var(--primary);
    color: white;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0,172,193,0.28);
    padding: 20px 28px;
    margin-bottom: 16px;
    font-size: 1.3rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.selector-header:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.selector-content {
    background: white;
    border-radius: 20px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    padding: 24px 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, 110px);
    justify-content: center;
    gap: 16px;
    max-height: none;
    overflow-y: visible;
    overflow-x: hidden;
    transition: all 0.4s ease;
}

@media (max-width: 640px) {
    .selector-content {
        grid-template-columns: repeat(3, 1fr);
        max-height: 360px;
        overflow-y: auto;
        padding: 16px 12px;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .selector-content {
        grid-template-columns: repeat(2, 1fr);
    }
}

.selector-content.collapsed {
    display: none;
    max-height: 0;
    padding: 0;
    overflow: hidden;
}

#lessonCheckboxes {
    display: contents; /* è®©å­å…ƒç´ ç›´æ¥å‚ä¸çˆ¶çº§çš„ grid å¸ƒå±€ */
}

.lesson-checkbox {
    background: #f8fdff;
    border: 2px solid transparent;
    border-radius: 16px;
    padding: 18px 22px;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.lesson-checkbox:hover {
    background: var(--bg-hover);
    border-color: var(--primary-light);
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0,172,193,0.18);
}

.lesson-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    margin-right: 16px;
    accent-color: var(--primary);
    cursor: pointer;
}

.lesson-info {
    font-weight: 600;
    font-size: 1.1rem;
    flex: 1;
}

.lesson-count {
    color: var(--text-muted);
    font-size: 0.95rem;
    background: rgba(0,172,193,0.15);
    padding: 4px 12px;
    border-radius: 20px;
}

/* ==================== Circle Cards (Grid Layout) ==================== */
.circle-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 12px;
    border-radius: 16px;
}

.circle-card:hover:not(.locked) {
    transform: translateY(-4px);
}

.circle-card.locked {
    cursor: not-allowed;
    opacity: 0.5;
}

/* Circle Progress Ring */
.circle-progress {
    position: relative;
    width: 100px;
    height: 100px;
}

.progress-ring {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.progress-ring-bg {
    fill: none;
    stroke: #e0e0e0;
    stroke-width: 6;
}

.progress-ring-circle {
    fill: none;
    stroke: var(--primary);
    stroke-width: 6;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;
}

/* Selected state - fill the circle */
.circle-card[data-selected="true"] .progress-ring-circle {
    stroke: var(--primary);
}

.circle-card[data-selected="true"] .circle-content {
    background: var(--primary);
    color: white;
}

.circle-card[data-selected="true"] .progress-text,
.circle-card[data-selected="true"] .char-count {
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.circle-card[data-selected="true"] .circle-label {
    color: var(--primary);
    font-weight: 700;
}
/* Circle Content (center of the ring) */
.circle-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.lesson-num {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
}

.progress-text {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary);
}

.circle-card[data-selected="true"] .lesson-num,
.circle-card[data-selected="true"] .progress-text {
    color: white;
}

/* Lock icon for coming soon */
.lock-icon {
    font-size: 2rem;
}

/* Labels below circle */
.circle-label {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    text-align: center;
}

.circle-sublabel {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-align: center;
}

@media (max-width: 640px) {
    .circle-progress {
        width: 80px;
        height: 80px;
    }

    .circle-content {
        width: 64px;
        height: 64px;
    }

    .progress-text {
        font-size: 1.1rem;
    }

    .circle-label {
        font-size: 0.85rem;
    }
}



.selector-actions {
    padding: 20px 0 0;
    display: flex;
    gap: 16px;
    justify-content: center;
    background: transparent;
    border-top: none;
}

@media (max-width: 640px) {
    .selector-actions {
        flex-direction: column;
        gap: 10px;
        padding: 16px 0 0;
    }
    .selector-actions .btn {
        width: 100%;
    }
}
    /* ==================== Smart Recommendation ==================== */
    .recommended-section {
        background: var(--primary-light);   /* çº¯è‰²æµ…è“ç»¿ */
        border-radius: 20px;
        padding: 32px;
        margin: 32px 0;
        box-shadow: 0 10px 35px rgba(0,172,193,0.22);
        transition: 0.3s;
        cursor: pointer;
        border: 1px solid var(--border);
    }

    @media (max-width: 640px) {
        .recommended-section {
            padding: 20px 16px;
            margin: 20px 0;
            border-radius: 16px;
        }
    }

            /* æ§åˆ¶ Smart Review å’Œ By Difficulty çš„é¡¯ç¤º/éš±è— */
        #recommendedSection {
            display: none;  /* é è¨­éš±è— */
        }

        #recommendedSection.show {
            display: block;  /* Tab é»é¸æ™‚é¡¯ç¤º */
        }

        #difficultySection {
            display: none;  /* é è¨­éš±è— */
        }

        #difficultySection.show {
            display: block;  /* Tab é»é¸æ™‚é¡¯ç¤º */
        }
    .recommended-section:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(0,172,193,0.28); }
    
    .recommended-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .recommended-title-group { display: flex; align-items: center; gap: 14px; }
    .recommended-icon { font-size: 36px; }
    .recommended-title { font-size: 26px; font-weight: 700; color: var(--primary-dark); }
    .collapse-arrow { font-size: 1.8rem; transition: 0.3s; color: var(--primary-dark); }
    .recommended-section.collapsed .collapse-arrow { transform: rotate(180deg); }
    .recommended-section.collapsed .recommended-content { display: none; }

    .recommended-subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 24px; font-size: 15px; }

    @media (max-width: 640px) {
        .recommended-icon { font-size: 28px; }
        .recommended-title { font-size: 1.3rem; }
        .recommended-subtitle { font-size: 0.85rem; margin-bottom: 16px; }
        .recommended-header { margin-bottom: 16px; }
    }
    .due-info {
        text-align: center;
        background: white;
        padding: 16px;
        border-radius: 14px;
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-dark);
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .recommended-breakdown {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
        margin: 28px 0;
    }
        .breakdown-item {
            background: white;
            padding: 18px;
            border-radius: 14px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 3px solid var(--border); /* é¢„è®¾è¾¹æ¡† */
        }
    .breakdown-item.forgot { background: white; color: var(--text-primary); border: 3px solid var(--forgot); }
    .breakdown-item.hard   { background: white; color: var(--text-primary); border: 3px solid var(--hard); }
    .breakdown-item.good   { background: white; color: var(--text-primary); border: 3px solid var(--good); }
    .breakdown-item.easy   { background: white; color: var(--text-primary); border: 3px solid var(--easy); }
   .breakdown-count { font-size: 36px; font-weight: bold; }
    .breakdown-label { font-size: 14px; color: var(--text-secondary); }

    @media (max-width: 640px) {
        .recommended-breakdown {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        .breakdown-item {
            padding: 14px 10px;
        }
        .breakdown-count { font-size: 28px; }
        .breakdown-label { font-size: 0.8rem; }
    }
    
    .amount-selector { text-align: center; margin: 28px 0; }
    .amount-selector label { font-size: 17px; color: var(--text-primary); display: block; margin-bottom: 12px; }
    .amount-selector select {
        padding: 14px 20px;
        font-size: 17px;
        border: 2px solid var(--primary);
        border-radius: 14px;
        background: white;
        color: var(--primary-dark);
        min-width: 320px;
        cursor: pointer;
    }

    @media (max-width: 640px) {
        .amount-selector { margin: 20px 0; }
        .amount-selector label { font-size: 0.95rem; }
        .amount-selector select {
            min-width: auto;
            width: 100%;
            max-width: 100%;
            padding: 12px 16px;
            font-size: 0.9rem;
        }
    }
    
    .recommended-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 18px 48px;
        border-radius: 30px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: block;
        margin: 0 auto;
        box-shadow: 0 8px 25px rgba(0,172,193,0.35);
        transition: 0.3s;
    }
    .recommended-btn:hover { background: var(--primary-dark); transform: translateY(-4px); }

    @media (max-width: 640px) {
        .recommended-btn {
            padding: 14px 32px;
            font-size: 1rem;
        }
    }

    /* ==================== Mastery Boxes ==================== */
    .mastery-boxes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin: 32px 0;
    }
    @media (min-width: 768px) { .mastery-boxes { grid-template-columns: repeat(4, 1fr); } }
    
    .mastery-box {
        background:transparent;
        border-radius: 20px;
        padding: 32px 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        border: 3px solid rgba(0,0,0,0.1);;
    }
    .mastery-box.forgot { background: var(--forgot); }
    .mastery-box.hard   { background: var(--hard); }
    .mastery-box.good   { background: var(--good); }
    .mastery-box.easy   { background: var(--easy); }
    
    .mastery-box:hover { transform: translateY(-8px); box-shadow: 0 14px 30px rgba(0,0,0,0.18); }
    
    .box-title { font-size: 18px; font-weight: 600; color: #ffffff; margin-bottom: 8px; }
    .box-count { font-size: 42px; font-weight: bold; color: #ffffff; margin: 12px 0; }
    .box-description { font-size: 14px; color:#ffffff; }

    @media (max-width: 640px) {
        .mastery-box {
            padding: 24px 16px;
        }
        .box-title { font-size: 1rem; }
        .box-count { font-size: 32px; }
        .box-description { font-size: 0.8rem; }
    }

    /* ==================== Review Area (ä½ åŸæœ¬çš„å¡ç‰‡åŒºä¿æŒå®Œç¾) ==================== */
    .review-area { text-align: center; margin: 30px 0; }
    .current-session { font-size: 20px; color: var(--text-secondary); font-weight: bold; margin: 20px 0; }

    .card {
        perspective: 1000px;
        height: 600px;
        margin: 20px auto;
        cursor: pointer;
        max-width: 700px;
        width: 100%;
    }

    @media (max-width: 640px) {
        .review-area { margin: 20px 0; }
        .current-session { font-size: 1.1rem; margin: 16px 0; }
        .card {
            height: 550px;
            margin: 16px auto;
        }
    }
    .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    
    .card-front, .card-back {
        position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
        border-radius: 20px; padding: 24px; display: flex; flex-direction: column;
        justify-content: flex-start; align-items: center; box-shadow: 0 10px 30px var(--shadow);
        overflow-y: auto;
    }

    @media (max-width: 640px) {
        .card-front, .card-back {
            padding: 16px 12px;
            justify-content: flex-start;
            overflow-y: auto;
        }
    }
    .card-front { background: white; border: 3px solid var(--border); }
    .card-back { background: var(--bg-light); border: 3px solid var(--primary); transform: rotateY(180deg); }

    .character { 
        font-size: 140px; 
        color: var(--primary-dark); 
        font-weight: bold;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
        max-width: 100%;
        text-align: center;
        line-height: 1.2;
    }
    .character.english-text {
        /* è‹±æ–‡æ–‡æœ¬ä½¿ç”¨è¾ƒå°å­—ä½“ï¼Œæ”¯æŒæ¢è¡Œ */
        font-size: clamp(30px, 8vw, 80px);
        line-height: 1.3;
    }
    .back-character { font-size: 80px; color: var(--primary-dark); }
    .pinyin { font-size: 30px; color: var(--primary); margin: 10px 0; font-weight: bold; }
    .meaning { font-size: 22px; color: var(--text-primary); line-height: 1.5; }

    @media (max-width: 640px) {
        .character { 
            font-size: 100px;
        }
        .character.english-text {
            font-size: clamp(24px, 6vw, 60px);
        }
        .back-character { font-size: 50px; }
        .pinyin { font-size: 20px; margin: 6px 0; }
        .meaning { font-size: 1rem; }
    }
        .meaning {
            font-size: 20px;
            color: var(--secondary-color);
            line-height: 1.4;
            margin: 8px 0;
        }
        
        .card-image {
            max-width: 100%;
            max-height: 300px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            margin: 12px 0;
        }

        @media (max-width: 640px) {
            .card-image {
                max-height: 150px;
            }
        }
        
        .card-content {
            text-align: left;
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .content-label {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        /* ==================== Markdown Image Styles (Alt-based) ==================== */
        .card-content img.img-comp {
            height: 1.8em;
            width: auto;
            display: inline-block;
            vertical-align: middle;
            margin: 0 4px;
        }
        
        .card-content img.img-origin {
            max-width: 100%;
            height: 200px;
            object-fit: contain;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 8px;
            display: block;
            margin: 12px auto;
        }
        
        .card-content img.img-story {
            max-width: 100%;
            height: 250px;
            object-fit: contain;
            border-radius: 8px;
            display: block;
            margin: 12px auto;
        }
        
        .phrase-example-section {
            width: 100%;
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-md);
            border-top: 2px solid var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        
        .phrase-example-title {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--primary-dark);
            margin-bottom: var(--spacing-sm);
            text-align: center;
        }
        
        .phrase-example-item {
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-sm);
        }
        
        .phrase-example-label {
            font-weight: var(--font-semibold);
            margin-bottom: var(--spacing-xs);
        }
        
        .phrase-example-text {
            font-size: var(--text-base);
            line-height: 1.6;
        }
        
        .speak-btn {
            background: var(--primary-dark);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 0;
            transition: all 0.3s;
        }

        .speak-btn:hover {
            background: var(--success);
        }

        @media (max-width: 640px) {
            .speak-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
                margin: 6px 0;
            }
        }
    .review-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        max-width: 600px;
        margin: 30px auto;
    }
    @media (min-width: 768px) { .review-buttons { grid-template-columns: repeat(4, 1fr); } }

    .review-btn {
        padding: 18px;
        border: none;
        border-radius: 16px;
        font-weight: bold;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
    }
    .btn-forgot { background: var(--forgot); }
    .btn-hard   { background: var(--hard); }
    .btn-good   { background: var(--good); }
    .btn-easy   { background: var(--easy); }
    .review-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

    @media (max-width: 640px) {
        .review-buttons {
            gap: 12px;
            margin: 20px auto;
        }
        .review-btn {
            padding: 14px 8px;
            font-size: 0.9rem;
        }
    }

    /* Progress Bar */
    .progress-bar {
        height: 36px;
        background: var(--bg-light);
        border-radius: 18px;
        overflow: hidden;
        margin: 24px 0;
        border: 2px solid var(--border);
    }
    .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
    }

    /* Buttons */
    .btn {
        padding: 12px 28px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: #94a3b8; color: white; }

    @media (max-width: 640px) {
        .btn {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
    }

    /* Messages & Data Section */
    .message { padding: 18px; border-radius: 14px; margin: 20px 0; text-align: center; font-weight: bold; }
    .message.success { background: #d1fae5; color: #065f46; border: 1px solid #34d399; }
    .message.error { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
    .message.info { background: #dbeafe; color: #1e40af; border: 1px solid #60a5fa; }
    .message.warning { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; }

    .data-section {
        margin: 32px 0 16px;
        padding: 24px;
        background: var(--bg-light);
        border-radius: 16px;
        border: 1px solid var(--border);
    }
    .data-section h3 { color: var(--primary-dark); margin-bottom: 16px; font-size: 1.3rem; }
    .data-actions { display: flex; flex-wrap: wrap; gap: 14px; justify-content: flex-start; }

    @media (max-width: 640px) {
        .data-section {
            margin: 20px 0 12px;
            padding: 16px;
        }
        .data-section h3 { font-size: 1.1rem; margin-bottom: 12px; }
        .data-actions {
            gap: 10px;
        }
    }

    .hidden { display: none !important; }


       /* Data Management */
        .data-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--bg-light);
            border-radius: 12px;
        }
        
        .data-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .data-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .mastery-boxes {
                grid-template-columns: repeat(4, 1fr);
            }

            .review-buttons {
                grid-template-columns: repeat(4, 1fr);
            }

            .character {
                font-size: 150px;
            }
        }

        @media (max-width: 480px) {
            .character {
                font-size: 80px;
            }

            .card {
                height: 500px;
            }

            .card-image {
                max-height: 100px;
            }

            .back-character {
                font-size: 38px;
            }

            .pinyin {
                font-size: 16px;
            }

            .meaning {
                font-size: 0.85rem;
            }

            .card-content {
                padding: 6px;
                font-size: 0.8rem;
            }
        }
</style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <!-- Desktop Navigation -->
        <div class="nav-content">
            <a href="../../index.html" class="nav-link">Home</a>
            <span class="nav-separator">|</span>
            <a href="../bct/lessons/lesson.html" class="nav-link">Lessons</a>
            <span class="nav-separator">|</span>
            <a href="lesson.html" class="nav-link">Literacy</a>
            <span class="nav-separator">|</span>
            <a href="review.html" class="nav-link active">Review Lit.</a>
            <span class="nav-separator group-separator">â€¢</span>
            <a href="../../pages/grammar.html" class="nav-link">Grammar</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/extras.html" class="nav-link">Extras</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/mini-story.html" class="nav-link">Mini Story</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/music.html" class="nav-link">Music</a>
            <span class="nav-separator group-separator">â€¢</span>
            <a href="../../pages/timeline.html" class="nav-link">Timeline</a>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <button class="hamburger-btn" aria-label="Open menu">â˜°</button>
            <span class="site-title">Chinese with Elisa</span>
        </div>
    </nav>

    <!-- Mobile Sidebar -->
    <div class="mobile-sidebar">
        <button class="close-sidebar" aria-label="Close menu">âœ•</button>

        <a href="../../index.html" class="mobile-menu-single">
            <span class="icon">ğŸ </span>
            <span>Home</span>
        </a>

        <div class="mobile-menu-group">
            <div class="mobile-menu-title">
                <span class="icon">ğŸ“š</span>
                <span>Courses</span>
            </div>
            <a href="../bct/lessons/lesson.html" class="mobile-menu-item">Lessons</a>
            <a href="lesson.html" class="mobile-menu-item">Literacy</a>
            <a href="review.html" class="mobile-menu-item active">Review Lit.</a>
        </div>

        <div class="mobile-menu-group">
            <div class="mobile-menu-title">
                <span class="icon">ğŸ“–</span>
                <span>Resources</span>
            </div>
            <a href="../../pages/grammar.html" class="mobile-menu-item">Grammar</a>
            <a href="../../pages/extras.html" class="mobile-menu-item">Extras</a>
            <a href="../../pages/mini-story.html" class="mobile-menu-item">Mini Story</a>
            <a href="../../pages/music.html" class="mobile-menu-item">Music</a>
        </div>

        <a href="../../pages/timeline.html" class="mobile-menu-single">
            <span class="icon">ğŸ“…</span>
            <span>Timeline</span>
        </a>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay"></div>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>ğŸ“š Chinese Character Review System</h1>
            <div class="subtitle">Cloud Sync â€¢ Spaced Repetition</div>
        </header>

        <!-- Loading -->
        <div id="loadingContainer">
            <div class="loader"></div>
            <p style="text-align: center; color: var(--text-secondary);">Loading...</p>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Tab System -->
            <div class="tab-system">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="components">Radical Components</button>
                    <button class="tab-btn" data-tab="characters">Character Lessons</button>
                    <button class="tab-btn" data-tab="phrases">è¯ç»„</button>
                </div>
            </div>
            
            <!-- Lesson Selection -->
            <div class="lesson-selector">
            <div style="padding: 20px 0; font-size: 1.3rem; font-weight: bold; color: var(--text-primary);">
                ğŸ“š Select Lessons <span class="selector-count" id="selectedCount">(0/25)</span>
            </div>
            <div style="text-align: center; color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                Select lessons to review the due cards<br>
                <span style="font-size: 0.85rem; opacity: 0.9;">(click multiple lessons to combine)</span>
            </div>
                <div class="selector-content" id="selectorContent">
                    <div id="lessonCheckboxes"></div>
                </div>
                <div class="selector-actions">
                    <button class="btn btn-primary" onclick="selectAllLessons()">Select All</button>
                    <button class="btn btn-secondary" onclick="clearAllLessons()">Clear All</button>
                </div>
            </div>

                        <!-- Layer 3: Review Method Tab -->
            <div class="tab-system" id="reviewMethodTabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="smart-review">ğŸ¯ Smart Review</button>
                    <button class="tab-btn" data-tab="by-difficulty">âš™ï¸ By Difficulty</button>
                </div>
            </div>
            
            <!-- Review Direction Selector (Shared by both Smart Review and By Difficulty) -->
            <div class="amount-selector" id="reviewDirectionSelector" style="display: none; margin-top: 20px;">
                <label>Review Direction:</label>
                <select id="reviewDirection">
                    <option value="forward">ä¸­æ–‡ â†’ è‹±æ–‡ (Chinese â†’ English)</option>
                    <option value="reverse">è‹±æ–‡ â†’ ä¸­æ–‡ (English â†’ Chinese)</option>
                </select>
            </div>
            
            <!-- Smart Recommendation -->
            <div class="recommended-section" id="recommendedSection">


                <div class="recommended-header">
                    <div class="recommended-title-group">
                        <span class="recommended-icon">ğŸ¯</span>
                        <div class="recommended-title">Smart Review Recommendation</div>
                    </div>                    
                </div>
                
                <div class="recommended-content">
                    <div class="recommended-subtitle">
                        ğŸ“… Spaced Repetition: Forgotten (daily) â€¢ Hard (1 day) â€¢ Good (3 days) â€¢ Easy (7 days)
                    </div>
                    
                    <div class="due-info" id="dueInfo">
                        Due Today: <span id="totalDue">0</span> <span id="dueItemType">characters</span>
                    </div>
                    
                    <div class="amount-selector">
                        <label>Select Review Amount:</label>
                        <select id="reviewAmount">
                            <option value="20">20 (Quick Daily Review)</option>
                            <option value="30">30 (Standard)</option>
                            <option value="50">50 (Intensive Practice)</option>
                            <option value="all">All Due Items (When you have time!)</option>
                        </select>
                    </div>
                    
                    <div class="recommended-breakdown" id="recommendedBreakdown"></div>
                    
                    <button class="recommended-btn" onclick="startRecommendedReview()">
                        ğŸ§  Start Smart Review
                    </button>
                </div>
            </div>
            
            <!-- Difficulty Section (By Difficulty Tab) -->
            <div id="difficultySection" style="display: none;">
                <!-- Mastery Boxes -->
                <div class="mastery-boxes" id="masteryBoxes" style="display: grid;">
                    <div class="mastery-box forgot" onclick="startBoxReview('forgot')">
                        <div class="box-title">Forgotten</div>
                        <div class="box-count" id="count-forgot">0</div>
                        <div class="box-description">Needs frequent review</div>
                    </div>
                    <div class="mastery-box hard" onclick="startBoxReview('hard')">
                        <div class="box-title">Hard</div>
                        <div class="box-count" id="count-hard">0</div>
                        <div class="box-description">Still challenging</div>
                    </div>
                    <div class="mastery-box good" onclick="startBoxReview('good')">
                        <div class="box-title">Good</div>
                        <div class="box-count" id="count-good">0</div>
                        <div class="box-description">Doing well</div>
                    </div>
                    <div class="mastery-box easy" onclick="startBoxReview('easy')">
                        <div class="box-title">Easy</div>
                        <div class="box-count" id="count-easy">0</div>
                        <div class="box-description">Mastered</div>
                    </div>
                </div>
            </div>
            
            <!-- Review Area -->
            <div class="review-area hidden" id="reviewArea">
                <div class="current-session" id="currentSession">Review in Progress</div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                    </div>
                    <div class="progress-text" id="progressText">0/0 Reviewed</div>
                </div>
                
                <div class="card" id="card">
                    <div class="card-inner">
                        <div class="card-front">
                            <div class="character" id="character">ä¸€</div>
                            <div style="margin-top: 20px; color: var(--text-secondary);">Click to flip</div>
                        </div>
                        <div class="card-back">
                            <div class="back-character" id="backCharacter">ä¸€</div>
                            <div class="pinyin" id="pinyin">yÄ«</div>
                            <button class="speak-btn" onclick="speakPinyin(event)">ğŸ”Š Read</button>
                            <div class="meaning" id="meaning">one</div>
                            
                            <!-- Phrase Example Section -->
                            <div id="phraseExampleSection" class="phrase-example-section hidden">
                                <div class="phrase-example-title">ğŸ“– ä¾‹å¥</div>
                                <div id="phraseExampleContent"></div>
                            </div>
                            
                            <img id="cardImage" class="card-image hidden">
                            <div id="cardBookExplanation" class="card-content hidden">
                                <div class="content-label">ğŸ“– è§£é‡Š:</div>
                                <div id="bookExplanationContent"></div>
                            </div>
                            <div id="cardStory" class="card-content hidden">
                                <div class="content-label">è®°å¿†æ•…äº‹:</div>
                                <div id="storyContent"></div>
                            </div>
                            <div id="cardPhrases" class="card-content hidden">
                                <div class="content-label">è¯ç»„èŒƒä¾‹:</div>
                                <div id="phrasesContent"></div>
                            </div>
                            <div style="margin-top: 12px; color: var(--text-secondary);">Click to return</div>
                        </div>
                    </div>
                </div>
                
                <div class="review-buttons">
                    <button class="review-btn btn-forgot" onclick="handleCardMove('forgot')">
                        Forgotten<br>å¿˜è®°
                    </button>
                    <button class="review-btn btn-hard" onclick="handleCardMove('hard')">
                        Hard<br>å›°éš¾
                    </button>
                    <button class="review-btn btn-good" onclick="handleCardMove('good')">
                        Good<br>è‰¯å¥½
                    </button>
                    <button class="review-btn btn-easy" onclick="handleCardMove('easy')">
                        Easy<br>ç®€å•
                    </button>
                </div>
                
                <button class="btn btn-secondary" onclick="endReview()" style="margin-top: 20px;">
                    End Review
                </button>
            </div>
            
            <!-- Completion Message -->
            <div id="completionMessage" class="message hidden"></div>
            
<!-- Data Management -->            
<div class="data-section">
    <h3>ğŸ“ Data Management</h3>
    
    <!-- æŒ‰é’®ç»„ -->
    <div class="data-actions">
        <button class="btn btn-primary" onclick="exportProgress()">ğŸ“¥ Export Progress</button>
        <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">ğŸ“¤ Import Data</button>
         <button class="btn btn-secondary" onclick="showDeviceCodeInput()">ğŸ”„ Sync Another Device</button>
        <button class="btn btn-secondary" onclick="refreshData()" style="background: white; color: var(--primary); border: 2px solid var(--primary);">
            ğŸ”„ Refresh Data
        </button>
    </div>
    
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <!-- Device Code & Student Name Display -->
    <div style="margin-top: 20px; padding: 16px; background: rgba(0,172,193,0.1); border-radius: 10px; text-align: center;">
        <div style="margin-bottom: 8px;">
            <span style="font-size: 0.9em; color: var(--text-secondary);">Device Code:</span>
            <strong style="font-size: 1.5em; color: var(--primary); margin: 0 10px;" id="deviceCode">------</strong>
        </div>
        <div style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 12px;">
            (Enter this code on another device to sync progress)
        </div>
        <div style="margin-bottom: 8px;">
            <span style="font-size: 0.9em; color: var(--text-secondary);">Student Name:</span>
            <strong style="font-size: 1.2em; color: var(--primary-dark); margin: 0 10px;" id="studentNameDisplay">Not set</strong>
        </div>
        <button class="btn btn-secondary" onclick="editStudentName()" style="padding: 8px 20px; font-size: 0.9rem;">
            ğŸ“ <span id="editNameBtnText">Set Name</span>
        </button>
    </div>

<style>
@media (max-width: 640px) {
    .data-section > div[style*="padding: 16px"] {
        padding: 12px !important;
    }
    .data-section > div[style*="padding: 16px"] span {
        font-size: 0.8rem !important;
    }
    .data-section > div[style*="padding: 16px"] strong {
        font-size: 1.2em !important;
        display: block;
        margin: 8px 0 !important;
    }
}
</style>
    
    
    <!-- è¯´æ˜æ–‡å­— -->
    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 14px; line-height: 1.5; text-align: center;" class="sync-info">
        ğŸ’¡ Your progress is automatically synced to the cloud.<br>
        To continue on another device, simply enter the Device Code shown above.
    </div>

<style>
@media (max-width: 640px) {
    .sync-info {
        font-size: 0.75rem !important;
    }
}
</style>
</div>
            </div>
        </div> <!-- end of #mainContent -->
    </div> <!-- end of .container -->

    <!-- Username Modal -->
    <div id="usernameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <h2 style="color: var(--primary-dark); font-size: 2rem; margin-bottom: 8px;">è¯·è¾“å…¥ç”¨æˆ·å ğŸ‘¤</h2>
                <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 1.6;">
                    è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·åä»¥è®¿é—®å­¦ä¹ ç³»ç»Ÿ<br>
                    <small style="color: var(--text-muted);">ï¼ˆç”¨æˆ·åç”±è€å¸ˆæä¾›ï¼‰</small>
                </p>
            </div>

            <input type="text" id="usernameInput" placeholder="è¾“å…¥ç”¨æˆ·åï¼ˆå¦‚ï¼šzhangweiï¼‰"
                   style="width: 100%; padding: 14px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 12px; text-transform: lowercase;"
                   autocomplete="off">
            
            <div id="usernameError" style="color: var(--danger-color); font-size: 0.9em; margin-bottom: 12px; min-height: 20px; display: none;"></div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="verifyAndSaveUsername()" style="flex: 1;">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <!-- Migration Modal (import data from old device) -->
    <div id="migrationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <h2 style="color: var(--primary-dark); font-size: 2rem; margin-bottom: 8px;">å¯¼å…¥æ—§è®¾å¤‡æ•°æ®ï¼Ÿ ğŸ“¥</h2>
                <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 1.6;">
                    æ‚¨æ˜¯å¦è¦ä»æ—§è®¾å¤‡å¯¼å…¥å­¦ä¹ è®°å½•ï¼Ÿ<br>
                    <small style="color: var(--text-muted);">è¯·è¾“å…¥æ—§è®¾å¤‡çš„è®¾å¤‡ç </small>
                </p>
            </div>

            <input type="text" id="migrationDeviceCode" placeholder="è¾“å…¥æ—§è®¾å¤‡ç ï¼ˆ6ä½ï¼Œå¦‚ï¼šABC123ï¼‰"
                   style="width: 100%; padding: 14px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 12px; text-transform: uppercase;"
                   autocomplete="off" maxlength="6">
            
            <div id="migrationError" style="color: var(--danger-color); font-size: 0.9em; margin-bottom: 12px; min-height: 20px; display: none;"></div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="skipMigration()" style="flex: 1;">è·³è¿‡ï¼Œåˆ›å»ºæ–°è®°å½•</button>
                <button class="btn btn-primary" onclick="migrateFromDeviceCode()" style="flex: 1;">å¯¼å…¥æ•°æ®</button>
            </div>
        </div>
    </div>
    
    <!-- Student Name Modal (for display name, optional) -->
    <div id="nameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <h2 style="color: var(--primary-dark); font-size: 2rem; margin-bottom: 8px;">Welcome! ğŸ‘‹</h2>
                <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 1.6;">
                    è¯·è¾“å…¥æ‚¨çš„å§“åï¼ˆå¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºï¼‰
                </p>
            </div>

            <input type="text" id="studentNameInput" placeholder="æ‚¨çš„å§“åï¼ˆå¯é€‰ï¼‰"
                   style="width: 100%; padding: 14px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 20px;">

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="skipNameInput()" style="flex: 1;">è·³è¿‡</button>
                <button class="btn btn-primary" onclick="saveStudentName()" style="flex: 1;">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase Configuration ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDMDTDwDP0mEXwgJdwsXVMB2IFi9Q5zfyU",
            authDomain: "shizi-with-elisa.firebaseapp.com",
            projectId: "shizi-with-elisa",
            storageBucket: "shizi-with-elisa.firebasestorage.app",
            messagingSenderId: "46368268308",
            appId: "1:46368268308:web:5847aeb7b239b16d624701"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // ==================== Global Variables ====================
        let currentUser = null;
        let deviceCode = null;
        let studentName = '';
        let username = ''; // ç”¨æˆ·åï¼ˆç™½åå•éªŒè¯ç”¨ï¼‰
        let allCharacters = [];
        let componentCharacters = [];
        let targetCharacters = [];
        let phraseItems = [];
        let userProgress = {};
        let currentTab = 'components';
        let reviewQueue = [];
        let currentReviewIndex = 0;
        let isCardFlipped = false;
        let reviewDirection = 'forward'; // 'forward' (ä¸­æ–‡â†’è‹±æ–‡) or 'reverse' (è‹±æ–‡â†’ä¸­æ–‡)
        let saveProgressTimeout = null; // é˜²æŠ–è¨ˆæ™‚å™¨
        let pendingSave = false; // æ¨™è¨˜æ˜¯å¦æœ‰å¾…ä¿å­˜çš„æ›´æ”¹
        
        // ==================== Initialization ====================
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Anonymous login
                await auth.signInAnonymously();
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        deviceCode = user.uid.substring(0, 6).toUpperCase();
                        // æ˜¾ç¤º deviceCodeï¼Œå¦‚æœç”¨æˆ·åå·²è®¾ç½®ï¼Œä¹Ÿä¼šåœ¨éªŒè¯åæ›´æ–°æ˜¾ç¤º
                        updateDeviceCodeDisplay();
                        
                        // Check and verify username first
                        await checkAndVerifyUsername();
                        
                        // Only proceed if username is verified
                        if (username) {
                            // Load data in correct order
                            await loadLessonsFromFirebase();
                            await loadUserProgress();

                            // Update student name display
                            updateStudentNameDisplay();

                            // Render with progress data
                            renderLessonCheckboxes();

                            // Show main content
                            document.getElementById('loadingContainer').classList.add('hidden');
                            document.getElementById('mainContent').classList.remove('hidden');

                            // åˆå§‹åŒ–æ˜¾ç¤ºé€»è¾‘
                            updateDueInfoText();
                            const directionSelector = document.getElementById('reviewDirectionSelector');
                            if (directionSelector) {
                                directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
                            }

                            updateStats();

                            // Check if we need to show name input modal (for display name)
                            checkAndShowNameModal();
                        }
                    }
                });
            } catch (error) {
                showMessage('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });
        
        // ==================== Save on Page Unload ====================
        // ç¢ºä¿åœ¨é é¢é—œé–‰æ™‚ä¿å­˜æ‰€æœ‰å¾…ä¿å­˜çš„é€²åº¦
        window.addEventListener('beforeunload', async (e) => {
            if (pendingSave && currentUser) {
                // ä½¿ç”¨åŒæ­¥æ–¹å¼ä¿å­˜ï¼ˆä¸ç­‰å¾…å®Œæˆï¼Œå› ç‚ºé é¢å³å°‡é—œé–‰ï¼‰
                // ä½†è‡³å°‘å˜—è©¦ç™¼é€ä¿å­˜è«‹æ±‚
                if (saveProgressTimeout) {
                    clearTimeout(saveProgressTimeout);
                }
                // ä½¿ç”¨ sendBeacon æˆ–ç›´æ¥ä¿å­˜ï¼ˆä¸ç­‰å¾…ï¼‰
                try {
                    if (username) {
                        await db.collection('user_progress').doc(username).set({
                            characterProgress: userProgress,
                            lastReview: new Date().toISOString(),
                            deviceCode: deviceCode,
                            studentName: studentName,
                            username: username,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                } catch (error) {
                    console.error('Error saving on unload:', error);
                }
            }
        });
        
        // ==================== Load Lessons from Firebase ====================
        async function loadLessonsFromFirebase() {
            try {
            console.time('Loading');  // â† åŠ è¿™è¡Œ

            // ========== ç·©å­˜æª¢æŸ¥ï¼ˆå«ç‰ˆæœ¬æ§åˆ¶ï¼‰==========
        const CACHE_VERSION = 3;  // ç™¼å¸ƒæ©Ÿåˆ¶ç‰ˆæœ¬ï¼ˆå¢åŠ phrasesæ”¯æŒï¼‰
        const MAX_CACHE_AGE = 1000 * 60 * 30;  // 30 åˆ†é˜ç·©å­˜éæœŸ
        const cached = localStorage.getItem('lessons_cache');
        if (cached) {
            const data = JSON.parse(cached);
            const cacheAge = Date.now() - (data.cacheTime || 0);
            // æª¢æŸ¥ç‰ˆæœ¬å’Œæ™‚æ•ˆ
            if (data.version === CACHE_VERSION && cacheAge < MAX_CACHE_AGE) {
                componentCharacters = data.components;
                targetCharacters = data.targets;
                phraseItems = data.phrases || [];
                console.log('âœ… Loaded from cache!');
                console.timeEnd('Loading');
                return;
            } else {
                console.log('ğŸ”„ Cache expired or version mismatch, reloading...');
                localStorage.removeItem('lessons_cache');
            }
        }
                componentCharacters = [];
                targetCharacters = [];
                phraseItems = [];
                
// Load lessons 1-25
for (let i = 1; i <= 25; i++) {
    try {
        const doc = await db.collection('lessons').doc(`lesson${i}`).get();
        if (doc.exists) {
            const data = doc.data();

            // Components - åªè¼‰å…¥å·²ç™¼å¸ƒçš„ (is_published !== falseï¼Œundefined è¦–ç‚ºå·²ç™¼å¸ƒä»¥å‘å¾Œå…¼å®¹)
            if (data.components && data.components.length > 0) {
                data.components
                    .filter(comp => comp.is_published !== false)
                    .forEach(comp => {
                        componentCharacters.push({
                            ...comp,
                            lesson: `lesson${i}`,
                            type: 'component'
                        });
                    });
            }

            // Target characters - åªè¼‰å…¥å·²ç™¼å¸ƒçš„
            if (data.target_characters && data.target_characters.length > 0) {
                data.target_characters
                    .filter(target => target.is_published !== false)
                    .forEach(target => {
                        targetCharacters.push({
                            ...target,
                            lesson: `lesson${i}`,
                            type: 'target'
                        });
                    });
            }

            // Phrases - åªè¼‰å…¥ subtype === 'phrase' çš„è©çµ„ï¼ˆæ’é™¤å°è©±ï¼‰
            if (data.phrases && data.phrases.length > 0) {
                data.phrases
                    .filter(phrase => phrase.subtype === 'phrase')
                    .forEach(phrase => {
                        // è§£æ content: "å›½å®¶|guÃ³jiÄ|country"
                        const parts = phrase.content.split('|').map(s => s.trim());
                        const chinese = parts[0] || '';
                        const pinyin = parts[1] || '';
                        const english = parts[2] || '';
                        
                        // ç”Ÿæˆå”¯ä¸€ID: lesson|è¯ç»„æ±‰å­—
                        const uniqueId = `lesson${i}|${chinese}`;
                        
                        phraseItems.push({
                            ...phrase,
                            chinese: chinese,
                            pinyin: pinyin,
                            english: english,
                            lesson: `lesson${i}`,
                            type: 'phrase',
                            uniqueId: uniqueId
                        });
                    });
            }
        }
    } catch (error) {
        console.log(`Lesson ${i} not found, skipping...`);
    }
}
                
                console.log(`Loaded ${componentCharacters.length} components, ${targetCharacters.length} targets, ${phraseItems.length} phrases`);
                // ========== å­˜ç·©å­˜ï¼ˆå«ç‰ˆæœ¬å’Œæ™‚é–“æˆ³ï¼‰==========
                    localStorage.setItem('lessons_cache', JSON.stringify({
                        components: componentCharacters,
                        targets: targetCharacters,
                        phrases: phraseItems,
                        version: 3,  // æ›´æ–°ç‰ˆæœ¬è™Ÿï¼ˆå¢åŠ phrasesæ”¯æŒï¼‰
                        cacheTime: Date.now()
                    }));
                    console.log('ğŸ’¾ Saved to cache!');
                    // ========== åˆ°è¿™é‡Œ ==========
                 console.timeEnd('Loading');  // â† åŠ è¿™è¡Œ
                
            } catch (error) {
                console.error('Error loading lessons:', error);
                showMessage('åŠ è½½è¯¾ç¨‹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ==================== Reset Layer 3 ====================
        function resetLayer3() {
            document.getElementById('reviewMethodTabs').style.display = 'none';
            document.getElementById('recommendedSection').style.display = 'none';
            document.getElementById('difficultySection').style.display = 'none';
        }
        function renderLessonCheckboxes() {
        console.time('Rendering');  // â† åŠ è¿™è¡Œ
            const container = document.getElementById('lessonCheckboxes');
            const lessons = [];
            
            for (let i = 1; i <= 25; i++) {
                const lessonId = `lesson${i}`;
                let items = [];
                if (currentTab === 'components') {
                    items = componentCharacters.filter(c => c.lesson === lessonId);
                } else if (currentTab === 'characters') {
                    items = targetCharacters.filter(c => c.lesson === lessonId);
                } else if (currentTab === 'phrases') {
                    items = phraseItems.filter(p => p.lesson === lessonId);
                }
                
                        // âœ… è¨ˆç®—é€²åº¦ï¼šEasy æ•¸é‡ / ç¸½æ•¸é‡
        let easyCount = 0;
        if (items.length > 0) {
            easyCount = items.filter(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ä½¿ç”¨uniqueIdä½œä¸ºkey
                    progress = userProgress[item.uniqueId];
                } else {
                    // ä½¿ç”¨characterä½œä¸ºkey
                    progress = userProgress[item.character];
                }
                return progress && progress.box === 'easy';
            }).length;
        }
        const progress = items.length > 0 ? Math.round((easyCount / items.length) * 100) : 0;
                
                if (items.length > 0) {
                    lessons.push({ 
                        id: lessonId, 
                        num: i, 
                        count: items.length,
                        progress: progress
                    });
                } else {
                    lessons.push({ 
                        id: lessonId, 
                        num: i, 
                        count: 0, 
                        comingSoon: true 
                    });
                }
            }
            
            container.innerHTML = lessons.map(lesson => {
                const lessonType = currentTab === 'components' ? 'Components' : (currentTab === 'characters' ? 'Characters' : 'Phrases');
                
                if (lesson.comingSoon) {
                    return `
<div class="circle-card locked" data-lesson="${lesson.id}">
    <div class="circle-progress">
        <svg viewBox="0 0 120 120" class="progress-ring">
            <circle cx="60" cy="60" r="54" class="progress-ring-bg"/>
            <circle cx="60" cy="60" r="54" class="progress-ring-circle" 
                    style="stroke-dasharray: 339.292; stroke-dashoffset: 339.292"/>
        </svg>
        <div class="circle-content">
            <div class="lock-icon">ğŸ”’</div>
        </div>
    </div>
    <div class="circle-label">Lesson ${lesson.num}</div>

</div>`;
                } else {
                    const circumference = 2 * Math.PI * 54;
                    const offset = circumference - (lesson.progress / 100) * circumference;
                    
                    return `
<div class="circle-card" data-lesson="${lesson.id}" data-selected="false" onclick="toggleLessonSelection('${lesson.id}')">
    <div class="circle-progress">
        <svg viewBox="0 0 120 120" class="progress-ring">
            <circle cx="60" cy="60" r="54" class="progress-ring-bg"/>
            <circle cx="60" cy="60" r="54" class="progress-ring-circle" 
                    style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}"/>
        </svg>
        <div class="circle-content">
    <div class="progress-text">${lesson.progress}%</div>
    <div class="char-count" style="font-size: 0.75rem;">${lesson.count}å­—</div>
        </div>
            </div>
            <div class="circle-label">Lesson ${lesson.num}</div>
        </div>`;
                }
            }).join('');
              console.timeEnd('Rendering');  // â† åŠ è¿™è¡Œ
        }
        
        // Toggle lesson selection
        function toggleLessonSelection(lessonId) {
            const card = document.querySelector(`[data-lesson="${lessonId}"]`);
            if (card.classList.contains('locked')) return;
            
            const isSelected = card.dataset.selected === 'true';
            card.dataset.selected = !isSelected;
            
            updateSelectedCount();
            updateLayer3Visibility();
        }
        
        // ==================== Update Layer 3 Visibility ====================
        function updateLayer3Visibility() {
            const selectedLessons = getSelectedLessons();
            const layer3 = document.getElementById('reviewMethodTabs');
            
            if (selectedLessons.length > 0) {
                // é¡¯ç¤ºå±¤ 3 Tab
                layer3.style.display = 'block';
                
                // é‡è¨­ç‚º Smart Reviewï¼ˆé è¨­ï¼‰
                document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('#reviewMethodTabs .tab-btn[data-tab="smart-review"]').classList.add('active');
                
                // åªé¡¯ç¤º Smart Review å…§å®¹
                document.getElementById('recommendedSection').style.display = 'block';
                document.getElementById('difficultySection').style.display = 'none';
            } else {
                // æ²’é¸èª²ç¨‹æ™‚éš±è—å±¤ 3 åŠå…¶å…§å®¹
                layer3.style.display = 'none';
                document.getElementById('recommendedSection').style.display = 'none';
                document.getElementById('difficultySection').style.display = 'none';
            }
        }
        
        // Get selected lessons
        function getSelectedLessons() {
            const selected = [];
            document.querySelectorAll('.circle-card[data-selected="true"]').forEach(card => {
                selected.push(card.dataset.lesson);
            });
            return selected;
        }
        
        // ==================== Layer 1: Tab Switching (Components vs Characters vs Phrases) ====================
        document.querySelectorAll('.tab-system:first-of-type .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active from all Layer 1 buttons
                document.querySelectorAll('.tab-system:first-of-type .tab-btn').forEach(b => b.classList.remove('active'));
                // Add active to clicked button
                btn.classList.add('active');
                currentTab = btn.dataset.tab;
                
                // æ˜¾ç¤º/éšè—å¤ä¹ æ–¹å‘é€‰æ‹©å™¨ï¼ˆåªåœ¨è¯ç»„tabæ˜¾ç¤ºï¼‰
                const directionSelector = document.getElementById('reviewDirectionSelector');
                if (directionSelector) {
                    directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
                }
                
                // æ›´æ–°due-infoçš„æ–‡å­—
                updateDueInfoText();
                
                // Render and reset
                renderLessonCheckboxes();
                clearAllLessons();
                updateStats();
            });
        });
        
        // ==================== Update Due Info Text ====================
        function updateDueInfoText() {
            const dueItemType = document.getElementById('dueItemType');
            if (dueItemType) {
                if (currentTab === 'phrases') {
                    dueItemType.textContent = 'phrases';
                } else if (currentTab === 'components') {
                    dueItemType.textContent = 'components';
                } else {
                    dueItemType.textContent = 'characters';
                }
            }
        }
        

        


        // ==================== Select/Clear All Lessons ====================
        function selectAllLessons() {
            document.querySelectorAll('.circle-card:not(.locked)').forEach(card => {
                card.dataset.selected = 'true';
            });
            updateSelectedCount();
        }
        
        function clearAllLessons() {
            document.querySelectorAll('.circle-card').forEach(card => {
                card.dataset.selected = 'false';
            });
            updateSelectedCount();
            resetLayer3();
        }
        
        function updateSelectedCount() {
            const checked = document.querySelectorAll('.circle-card[data-selected="true"]').length;
            const total = document.querySelectorAll('.circle-card:not(.locked)').length;
            document.getElementById('selectedCount').textContent = `(${checked}/${total})`;
            updateStats();
        }
        
        // ==================== Get Selected Characters ====================
        function getSelectedCharacters() {
            const selectedLessons = getSelectedLessons();
            
            let sourceItems = [];
            if (currentTab === 'components') {
                sourceItems = componentCharacters;
            } else if (currentTab === 'characters') {
                sourceItems = targetCharacters;
            } else if (currentTab === 'phrases') {
                sourceItems = phraseItems;
            }
            
            return sourceItems.filter(item => selectedLessons.includes(item.lesson));
        }
        
        // ==================== Update Statistics ====================
        function updateStats() {
            const items = getSelectedCharacters();
            const boxes = { forgot: 0, hard: 0, good: 0, easy: 0 };
            
            items.forEach(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ä½¿ç”¨uniqueIdä½œä¸ºkey
                    progress = userProgress[item.uniqueId];
                } else {
                    // ä½¿ç”¨characterä½œä¸ºkey
                    progress = userProgress[item.character];
                }
                const box = progress ? progress.box : 'forgot';
                boxes[box]++;
            });
            
            document.getElementById('count-forgot').textContent = boxes.forgot;
            document.getElementById('count-hard').textContent = boxes.hard;
            document.getElementById('count-good').textContent = boxes.good;
            document.getElementById('count-easy').textContent = boxes.easy;
            
            // Update due count
            const dueItems = getDueCharacters(items);
            document.getElementById('totalDue').textContent = dueItems.length;
            
            updateRecommendedBreakdown();
        }
        
        // ==================== Get Due Characters ====================
        function getDueCharacters(items) {
            const today = new Date().setHours(0, 0, 0, 0);
            
            return items.filter(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ä½¿ç”¨uniqueIdä½œä¸ºkey
                    progress = userProgress[item.uniqueId];
                } else {
                    // ä½¿ç”¨characterä½œä¸ºkey
                    progress = userProgress[item.character];
                }
                
                if (!progress) return true; // New item
                
                const lastReviewed = progress.lastReviewed ? new Date(progress.lastReviewed).setHours(0, 0, 0, 0) : null;
                if (!lastReviewed) return true;
                
                const daysSince = Math.floor((today - lastReviewed) / (1000 * 60 * 60 * 24));
                
                switch (progress.box) {
                    case 'forgot': return daysSince >= 0; // Daily
                    case 'hard': return daysSince >= 1;
                    case 'good': return daysSince >= 3;
                    case 'easy': return daysSince >= 7;
                    default: return true;
                }
            });
        }
        
        // ==================== Update Recommended Breakdown ====================
        function updateRecommendedBreakdown() {
            const items = getSelectedCharacters();
            const dueItems = getDueCharacters(items);
            const amount = document.getElementById('reviewAmount').value;
            
            let selectedItems = dueItems;
            if (amount !== 'all') {
                selectedItems = dueItems.slice(0, parseInt(amount));
            }
            
            const breakdown = { forgot: 0, hard: 0, good: 0, easy: 0 };
            selectedItems.forEach(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ä½¿ç”¨uniqueIdä½œä¸ºkey
                    progress = userProgress[item.uniqueId];
                } else {
                    // ä½¿ç”¨characterä½œä¸ºkey
                    progress = userProgress[item.character];
                }
                const box = progress ? progress.box : 'forgot';
                breakdown[box]++;
            });
            
            document.getElementById('recommendedBreakdown').innerHTML = `
                <div class="breakdown-item" style="border-color: var(--forgot); color: var(--forgot);">
                    <span class="breakdown-count">${breakdown.forgot}</span>
                    <span class="breakdown-label">Forgotten</span>
                </div>
                <div class="breakdown-item" style="border-color: var(--hard); color: var(--hard);">
                    <span class="breakdown-count">${breakdown.hard}</span>
                    <span class="breakdown-label">Hard</span>
                </div>
                <div class="breakdown-item" style="border-color: var(--good); color: var(--good);">
                    <span class="breakdown-count">${breakdown.good}</span>
                    <span class="breakdown-label">Good</span>
                </div>
                <div class="breakdown-item" style="border-color: var(--easy); color: var(--easy);">
                    <span class="breakdown-count">${breakdown.easy}</span>
                    <span class="breakdown-label">Easy</span>
                </div>
            `;
        }
        
        document.getElementById('reviewAmount').addEventListener('change', updateRecommendedBreakdown);
        
        // ==================== Start Reviews ====================
        function startRecommendedReview() {
            const items = getSelectedCharacters();
            const dueItems = getDueCharacters(items);
            const amount = document.getElementById('reviewAmount').value;
            
            if (dueItems.length === 0) {
                const itemType = currentTab === 'phrases' ? 'è¯ç»„' : 'å­—';
                showMessage(`No ${itemType} are due for review!æ²¡æœ‰åˆ°æœŸçš„${itemType}éœ€è¦å¤ä¹ ï¼`, 'info');
                return;
            }
            
            reviewQueue = amount === 'all' ? dueItems : dueItems.slice(0, parseInt(amount));
            shuffleArray(reviewQueue);
            startReview();
        }
        
        function startBoxReview(box) {
            const items = getSelectedCharacters();
            reviewQueue = items.filter(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ä½¿ç”¨uniqueIdä½œä¸ºkey
                    progress = userProgress[item.uniqueId];
                } else {
                    // ä½¿ç”¨characterä½œä¸ºkey
                    progress = userProgress[item.character];
                }
                return progress ? progress.box === box : box === 'forgot';
            });
            
            if (reviewQueue.length === 0) {
                const itemType = currentTab === 'phrases' ? 'è¯ç»„' : 'å­—';
                showMessage(`æ²¡æœ‰ ${box} éš¾åº¦çš„${itemType}ï¼`, 'info');
                return;
            }
            
            shuffleArray(reviewQueue);
            startReview();
        }
        
        function startReview() {
            currentReviewIndex = 0;
            // Hide all controls during review
            document.querySelectorAll('.tab-system').forEach(tab => tab.style.display = 'none');
            document.querySelector('.lesson-selector').style.display = 'none';
            document.querySelector('.recommended-section').style.display = 'none';
            document.querySelector('#difficultySection').style.display = 'none';
            // éšè—å¤ä¹ æ–¹å‘é€‰æ‹©å™¨ï¼ˆå¤ä¹ æ—¶ä¸éœ€è¦æ˜¾ç¤ºï¼‰
            const directionSelector = document.getElementById('reviewDirectionSelector');
            if (directionSelector) {
                directionSelector.style.display = 'none';
            }
            // Show review area
            document.getElementById('reviewArea').classList.remove('hidden');
            showCard();
        }
        
        function endReview() {
            document.getElementById('reviewArea').classList.add('hidden');
            document.querySelectorAll('.tab-system').forEach(tab => tab.style.display = 'block');
            document.querySelector('.lesson-selector').style.display = 'block';
            document.getElementById('reviewMethodTabs').style.display = 'block';
            
            // æ˜¾ç¤ºå¤ä¹ æ–¹å‘é€‰æ‹©å™¨ï¼ˆå¦‚æœåœ¨è¯ç»„tabï¼‰
            const directionSelector = document.getElementById('reviewDirectionSelector');
            if (directionSelector && currentTab === 'phrases') {
                directionSelector.style.display = 'block';
            }
            
            // Reset to Smart Review tab
            document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#reviewMethodTabs .tab-btn[data-tab="smart-review"]').classList.add('active');
            document.getElementById('recommendedSection').style.display = 'block';
            document.getElementById('difficultySection').style.display = 'none';
            
            updateStats();
        }
        
        // ==================== Show Card ====================
        function showCard() {
            if (currentReviewIndex >= reviewQueue.length) {
                showCompletion();
                return;
            }
            
            const item = reviewQueue[currentReviewIndex];
            isCardFlipped = false;
            document.getElementById('card').classList.remove('flipped');
            
            // è·å–å¤ä¹ æ–¹å‘
            const direction = document.getElementById('reviewDirection') ? document.getElementById('reviewDirection').value : 'forward';
            reviewDirection = direction;
            
            const characterElement = document.getElementById('character');
            
            // å¦‚æœæ˜¯è¯ç»„
            if (currentTab === 'phrases') {
                if (direction === 'forward') {
                    // æ­£å‘ï¼šæ­£é¢æ˜¾ç¤ºæ±‰å­—ï¼ŒèƒŒé¢æ˜¾ç¤ºæ‹¼éŸ³+è‹±æ–‡
                    characterElement.textContent = item.chinese;
                    document.getElementById('backCharacter').textContent = item.chinese;
                    document.getElementById('pinyin').textContent = item.pinyin;
                    document.getElementById('meaning').textContent = item.english;
                    // æ±‰å­—ä¸éœ€è¦è‹±æ–‡æ ·å¼
                    characterElement.classList.remove('english-text');
                } else {
                    // åå‘ï¼šæ­£é¢æ˜¾ç¤ºè‹±æ–‡ï¼ŒèƒŒé¢æ˜¾ç¤ºæ±‰å­—+æ‹¼éŸ³
                    characterElement.textContent = item.english;
                    document.getElementById('backCharacter').textContent = item.chinese;
                    document.getElementById('pinyin').textContent = item.pinyin;
                    document.getElementById('meaning').textContent = item.chinese;
                    // è‹±æ–‡éœ€è¦ç‰¹æ®Šæ ·å¼ï¼ˆæ¢è¡Œ+è¾ƒå°å­—ä½“ï¼‰
                    characterElement.classList.add('english-text');
                    // æ ¹æ®è‹±æ–‡é•¿åº¦åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
                    adjustEnglishFontSize(characterElement, item.english);
                }
                
                // æ˜¾ç¤ºä¾‹å¥ï¼ˆå¦‚æœæœ‰ï¼‰
                const phraseExampleSection = document.getElementById('phraseExampleSection');
                const hasExample = item.notes || item.example_en || item.example_es;
                
                if (hasExample) {
                    let exampleHTML = '';
                    
                    // ä¸­æ–‡ä¾‹å¥
                    if (item.notes && item.notes.trim()) {
                        exampleHTML += `
                            <div class="phrase-example-item">
                                <div class="phrase-example-label" style="color: var(--character-color);">ä¸­æ–‡ï¼š</div>
                                <div class="phrase-example-text">${item.notes}</div>
                            </div>
                        `;
                    }
                    
                    // è‹±æ–‡ç¿»è¯‘
                    if (item.example_en && item.example_en.trim()) {
                        exampleHTML += `
                            <div class="phrase-example-item">
                                <div class="phrase-example-label" style="color: var(--english-color);">English:</div>
                                <div class="phrase-example-text" style="color: var(--english-color);">${item.example_en}</div>
                            </div>
                        `;
                    }
                    
                    // è¥¿ç­ç‰™è¯­ç¿»è¯‘
                    if (item.example_es && item.example_es.trim()) {
                        exampleHTML += `
                            <div class="phrase-example-item">
                                <div class="phrase-example-label" style="color: var(--spanish-color);">EspaÃ±ol:</div>
                                <div class="phrase-example-text" style="color: var(--spanish-color);">${item.example_es}</div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('phraseExampleContent').innerHTML = exampleHTML;
                    phraseExampleSection.classList.remove('hidden');
                } else {
                    phraseExampleSection.classList.add('hidden');
                }
                
                // éšè—ä¸éœ€è¦çš„å…ƒç´ 
                document.getElementById('cardImage').classList.add('hidden');
                document.getElementById('cardBookExplanation').classList.add('hidden');
                document.getElementById('cardStory').classList.add('hidden');
                document.getElementById('cardPhrases').classList.add('hidden');
            } else {
                // å­—ç¬¦ï¼ˆéƒ¨ä»¶æˆ–ç›®æ ‡å­—ï¼‰
                characterElement.textContent = item.character;
                document.getElementById('backCharacter').textContent = item.character;
                document.getElementById('pinyin').textContent = item.pinyin;
                document.getElementById('meaning').textContent = item.meaning;
                // å­—ç¬¦ä¸éœ€è¦è‹±æ–‡æ ·å¼
                characterElement.classList.remove('english-text');
                
                // éšè—è¯ç»„ä¾‹å¥åŒºåŸŸ
                document.getElementById('phraseExampleSection').classList.add('hidden');
                
                // Image
                const cardImage = document.getElementById('cardImage');
                if (item.image) {
                    cardImage.src = item.image;
                    cardImage.classList.remove('hidden');
                } else {
                    cardImage.classList.add('hidden');
                }
                
                // Book Explanation
                const cardBookExplanation = document.getElementById('cardBookExplanation');
                if (item.book_explanation && item.book_explanation.trim()) {
                    const processedExplanation = processMarkdownImages(marked.parse(item.book_explanation));
                    document.getElementById('bookExplanationContent').innerHTML = processedExplanation;
                    cardBookExplanation.classList.remove('hidden');
                } else {
                    cardBookExplanation.classList.add('hidden');
                }
                
                // Story
                const cardStory = document.getElementById('cardStory');
                if (item.story && item.story.trim()) {
                    const processedStory = processMarkdownImages(marked.parse(item.story));
                    document.getElementById('storyContent').innerHTML = processedStory;
                    cardStory.classList.remove('hidden');
                } else {
                    cardStory.classList.add('hidden');
                }
                
                // Phrases (for characters)
                const cardPhrases = document.getElementById('cardPhrases');
                if (item.phrases && item.phrases.trim()) {
                    const processedPhrases = processMarkdownImages(marked.parse(item.phrases));
                    document.getElementById('phrasesContent').innerHTML = processedPhrases;
                    cardPhrases.classList.remove('hidden');
                } else {
                    cardPhrases.classList.add('hidden');
                }
            }
            
            // Update progress
            updateProgress();
        }
        
        // ==================== Adjust English Font Size ====================
        function adjustEnglishFontSize(element, englishText) {
            if (!element || !englishText) return;
            
            const textLength = englishText.length;
            let fontSize;
            
            // æ ¹æ®è‹±æ–‡é•¿åº¦åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
            if (textLength <= 10) {
                // çŸ­å•è¯ï¼šè¾ƒå¤§å­—ä½“
                fontSize = window.innerWidth <= 640 ? 'clamp(32px, 7vw, 60px)' : 'clamp(50px, 8vw, 80px)';
            } else if (textLength <= 20) {
                // ä¸­ç­‰é•¿åº¦ï¼šä¸­ç­‰å­—ä½“
                fontSize = window.innerWidth <= 640 ? 'clamp(24px, 5vw, 45px)' : 'clamp(35px, 6vw, 60px)';
            } else {
                // é•¿å•è¯ï¼šè¾ƒå°å­—ä½“
                fontSize = window.innerWidth <= 640 ? 'clamp(18px, 4vw, 35px)' : 'clamp(28px, 5vw, 50px)';
            }
            
            element.style.fontSize = fontSize;
        }
        
        // ==================== Card Flip ====================
        document.getElementById('card').addEventListener('click', (e) => {
            if (e.target.classList.contains('speak-btn')) return;
            document.getElementById('card').classList.toggle('flipped');
        });
        
        // ==================== Handle Card Move ====================
        async function handleCardMove(box) {
            const item = reviewQueue[currentReviewIndex];
            
            // ç¡®å®šä½¿ç”¨çš„key
            let progressKey;
            if (currentTab === 'phrases') {
                progressKey = item.uniqueId;
            } else {
                progressKey = item.character;
            }
            
            // Update progress
            userProgress[progressKey] = {
                character: currentTab === 'phrases' ? item.chinese : item.character,
                lesson: item.lesson,
                box: box,
                reviews: (userProgress[progressKey]?.reviews || 0) + 1,
                lastReviewed: new Date().toISOString()
            };
            
            // æ¨™è¨˜æœ‰å¾…ä¿å­˜çš„æ›´æ”¹
            pendingSave = true;
            
            // ä½¿ç”¨é˜²æŠ–æ©Ÿåˆ¶ï¼šåªåœ¨3ç§’å…§æ²’æœ‰æ–°æ“ä½œæ™‚æ‰ä¿å­˜
            // é€™æ¨£å¯ä»¥å¤§å¹…æ¸›å°‘Firebaseå¯«å…¥æ¬¡æ•¸
            if (saveProgressTimeout) {
                clearTimeout(saveProgressTimeout);
            }
            saveProgressTimeout = setTimeout(() => {
                if (pendingSave) {
                    saveUserProgress();
                    pendingSave = false;
                }
            }, 3000); // 3ç§’é˜²æŠ–å»¶é²
            
            // Next card
            currentReviewIndex++;
            showCard();
        }
        
        // ==================== Update Progress Bar ====================
        function updateProgress() {
            const total = reviewQueue.length;
            const current = currentReviewIndex;
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('progressText').textContent = `${current}/${total} å·²å¤ä¹ `;
        }
        
        // ==================== Show Completion ====================
        async function showCompletion() {
            // ç¢ºä¿åœ¨å®Œæˆæ™‚ä¿å­˜æ‰€æœ‰å¾…ä¿å­˜çš„é€²åº¦
            if (saveProgressTimeout) {
                clearTimeout(saveProgressTimeout);
            }
            if (pendingSave) {
                await saveUserProgress();
                pendingSave = false;
            }
            
            document.getElementById('reviewArea').classList.add('hidden');
            const msg = document.getElementById('completionMessage');
            
            // æ”¹æˆé¡¯ç¤ºå®Œæˆè¨Šæ¯ + æŒ‰éˆ•ï¼Œä¸è¦è‡ªå‹•è·³å›
            msg.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ‰</div>
                    <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px;">Great job!</div>
                    <div style="font-size: 1rem; margin-bottom: 24px;">You've reviewed ${reviewQueue.length} ${currentTab === 'phrases' ? 'phrases' : 'characters'}</div>
                    <button class="btn btn-primary" onclick="returnToReviewHome()" style="padding: 14px 32px; font-size: 1rem;">
                        â† Back to Review Home
                    </button>
                </div>
            `;
            msg.className = 'message success';
            msg.classList.remove('hidden');
        }
        
        // ==================== Return to Review Home ====================
        function returnToReviewHome() {
            document.getElementById('completionMessage').classList.add('hidden');
            endReview();
        }
        
        function speakPinyin(event) {
            event.stopPropagation();
            let textToSpeak;
            
            if (currentTab === 'phrases') {
                // è¯ç»„ï¼šå‘éŸ³æ±‰å­—éƒ¨åˆ†
                textToSpeak = document.getElementById('backCharacter').textContent;
            } else {
                // å­—ç¬¦ï¼šå‘éŸ³å­—ç¬¦
                textToSpeak = document.getElementById('backCharacter').textContent;
            }
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            // å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡å£°éŸ³
            const voices = speechSynthesis.getVoices();
            const chineseVoice = voices.find(v => v.lang.includes('zh'));
            if (chineseVoice) utterance.voice = chineseVoice;
            
            utterance.lang = 'zh-CN';
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
        }
        
        // ==================== Process Markdown Images ====================
        function processMarkdownImages(html) {
            // Parse HTML and add classes based on alt text
            const div = document.createElement('div');
            div.innerHTML = html;
            
            const images = div.querySelectorAll('img');
            images.forEach(img => {
                const alt = img.getAttribute('alt') || '';
                
                if (alt === 'comp') {
                    img.classList.add('img-comp');
                } else if (alt === 'origin') {
                    img.classList.add('img-origin');
                } else if (alt === 'story') {
                    img.classList.add('img-story');
                }
            });
            
            return div.innerHTML;
        }
        
        // ==================== User Progress (Firebase) ====================
        async function loadUserProgress() {
            if (!username) {
                console.warn('Cannot load progress: username not set');
                return;
            }
            
            try {
                // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºæ–‡æ¡£ID
                const doc = await db.collection('user_progress').doc(username).get();
                if (doc.exists) {
                    const data = doc.data();
                    userProgress = data.characterProgress || {};
                    studentName = data.studentName || '';
                } else {
                    // æ–°ç”¨æˆ·ï¼Œåˆå§‹åŒ–ä¸ºç©º
                    userProgress = {};
                    studentName = '';
                }
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }
        
        async function saveUserProgress() {
            if (!username) {
                console.warn('Cannot save progress: username not verified');
                return;
            }
            
            try {
                // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºæ–‡æ¡£ID
                await db.collection('user_progress').doc(username).set({
                    characterProgress: userProgress,
                    lastReview: new Date().toISOString(),
                    deviceCode: deviceCode,
                    studentName: studentName,
                    username: username,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // ä½¿ç”¨ merge å¯ä»¥æ¸›å°‘å¯«å…¥æˆæœ¬
                console.log('âœ… Progress saved to Firebase');
            } catch (error) {
                console.error('âŒ Error saving progress:', error);
            }
        }
        
        // ==================== Import/Export ====================
        function exportProgress() {
            // å¯¼å‡ºå®Œæ•´æ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µ
            const data = {
                exportDate: new Date().toISOString(),
                exportType: 'single_student',
                student: {
                    deviceCode: deviceCode || '------',
                    studentName: studentName || '',
                    lastReview: new Date().toISOString(),
                    characterProgress: userProgress
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = `shizi-progress-${deviceCode || 'student'}-${new Date().toISOString().split('T')[0]}.json`;
            a.download = fileName;
            a.click();
            
            showMessage('âœ… èµ„æ–™å·²å¯¼å‡ºï¼', 'success');
        }
        
        document.getElementById('importFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                showMessage('æ­£åœ¨å¯¼å…¥æ•°æ®...', 'info');
                const text = await file.text();
                const data = JSON.parse(text);
                
                let progressToImport = null;
                
                // æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
                // 1. ä» admin å¯¼å‡ºçš„å®Œæ•´æ ¼å¼ï¼ˆå•ä¸ªå­¦ç”Ÿæˆ–æ‰€æœ‰å­¦ç”Ÿï¼‰
                if (data.exportType === 'single_student' && data.student) {
                    progressToImport = data.student.characterProgress || {};
                } else if (data.exportType === 'all_students' && data.students && data.students.length > 0) {
                    // å¦‚æœæ˜¯å¤šä¸ªå­¦ç”Ÿï¼Œè®©ç”¨æˆ·é€‰æ‹©æˆ–ä½¿ç”¨ç¬¬ä¸€ä¸ª
                    if (data.students.length === 1) {
                        progressToImport = data.students[0].characterProgress || {};
                    } else {
                        // å¤šä¸ªå­¦ç”Ÿæ—¶ï¼Œå°è¯•åŒ¹é…å½“å‰è®¾å¤‡ç 
                        const currentCode = deviceCode || '';
                        const matched = data.students.find(s => 
                            s.deviceCode && s.deviceCode.toUpperCase() === currentCode.toUpperCase()
                        );
                        if (matched) {
                            progressToImport = matched.characterProgress || {};
                        } else {
                            // æ²¡æœ‰åŒ¹é…çš„ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
                            progressToImport = data.students[0].characterProgress || {};
                            showMessage(`âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡ç ï¼Œå·²å¯¼å…¥ç¬¬ä¸€ä¸ªå­¦ç”Ÿçš„èµ„æ–™ï¼ˆ${data.students[0].deviceCode}ï¼‰`, 'warning');
                        }
                    }
                } 
                // 2. ä»å­¦ç”Ÿç«¯å¯¼å‡ºçš„ç®€å•æ ¼å¼
                else if (data.characterProgress) {
                    progressToImport = data.characterProgress;
                }
                // 3. ç›´æ¥æ˜¯ characterProgress å¯¹è±¡
                else if (typeof data === 'object' && !data.exportType) {
                    // æ£€æŸ¥æ˜¯å¦ç›´æ¥æ˜¯è¿›åº¦å¯¹è±¡
                    const hasCharacterFields = Object.values(data).some(v => 
                        v && typeof v === 'object' && (v.character || v.box || v.reviews !== undefined)
                    );
                    if (hasCharacterFields) {
                        progressToImport = data;
                    }
                }
                
                if (!progressToImport || Object.keys(progressToImport).length === 0) {
                    showMessage('âŒ æ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼ï¼è¯·ç¡®è®¤è¿™æ˜¯ä»æœ¬ç³»ç»Ÿå¯¼å‡ºçš„ JSON æ–‡ä»¶ã€‚', 'error');
                    return;
                }
                
                // åˆå¹¶æ¨¡å¼ï¼šä¿ç•™ä¸¤ä¸ªè®¾å¤‡ä¸­æ›´å¥½çš„å­¦ä¹ è®°å½•
                const beforeCount = Object.keys(userProgress).length;
                userProgress = mergeProgress(userProgress, progressToImport);
                const afterCount = Object.keys(userProgress).length;
                const addedCount = afterCount - beforeCount;
                
                await saveUserProgress();
                
                const message = addedCount > 0
                    ? `âœ… å¯¼å…¥æˆåŠŸï¼åˆå¹¶äº† ${addedCount} ä¸ªæ–°å­—çš„å­¦ä¹ è®°å½•ã€‚`
                    : 'âœ… å¯¼å…¥æˆåŠŸï¼å·²ä¿ç•™æ‚¨å½“å‰è®¾å¤‡ä¸­æ›´å¥½çš„å­¦ä¹ è®°å½•ã€‚';
                showMessage(message, 'success');
                updateStats();
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
                e.target.value = '';
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showMessage('âŒ å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        });
        
        // ==================== Device Code Sync ====================
        function showDeviceCodeInput() {
            const code = prompt('Enter device code from another device (6 digits):');
            if (!code) return;
            
            syncFromDeviceCode(code.toUpperCase());
        }
        
        // ==================== Merge Progress Helper ====================
        // åˆå¹¶ä¸¤ä¸ªè®¾å¤‡çš„è¿›åº¦æ•°æ®ï¼ˆæ™ºèƒ½åˆå¹¶ï¼Œä¿ç•™æ›´å¤šå­¦ä¹ è®°å½•ï¼‰
        function mergeProgress(currentProgress, newProgress) {
            const merged = { ...currentProgress };
            const boxPriority = { 'forgot': 0, 'hard': 1, 'good': 2, 'easy': 3 };
            
            // éå†æ–°è®¾å¤‡çš„æ‰€æœ‰å­—
            Object.keys(newProgress).forEach(char => {
                const newChar = newProgress[char];
                const currentChar = merged[char];
                
                if (!currentChar) {
                    // å½“å‰è®¾å¤‡æ²¡æœ‰è¿™ä¸ªå­—ï¼Œç›´æ¥æ·»åŠ 
                    merged[char] = { ...newChar };
                } else {
                    // ä¸¤ä¸ªè®¾å¤‡éƒ½æœ‰è¿™ä¸ªå­—ï¼Œé€‰æ‹©ä¿ç•™æ›´å¥½çš„è®°å½•
                    const newReviews = newChar.reviews || 0;
                    const currentReviews = currentChar.reviews || 0;
                    
                    // ä¼˜å…ˆä¿ç•™å¤ä¹ æ¬¡æ•°æ›´å¤šçš„
                    if (newReviews > currentReviews) {
                        merged[char] = { ...newChar };
                    } else if (newReviews === currentReviews) {
                        // å¦‚æœæ¬¡æ•°ç›¸åŒï¼Œä¿ç•™è®°å¿†ç›’ç­‰çº§æ›´é«˜çš„
                        const newBoxPriority = boxPriority[newChar.box] || 0;
                        const currentBoxPriority = boxPriority[currentChar.box] || 0;
                        if (newBoxPriority > currentBoxPriority) {
                            merged[char] = { ...newChar };
                        }
                        // å¦åˆ™ä¿ç•™å½“å‰çš„ï¼ˆå·²ç»æ˜¯æ›´å¥½çš„ï¼‰
                    }
                    // å¦‚æœå½“å‰è®¾å¤‡çš„å¤ä¹ æ¬¡æ•°æ›´å¤šï¼Œä¿ç•™å½“å‰çš„
                }
            });
            
            return merged;
        }
        
        async function syncFromDeviceCode(code) {
            try {
                showMessage('æ­£åœ¨åŒæ­¥æ•°æ®...', 'info');
                
                // Search for user with this device code
                const snapshot = await db.collection('user_progress')
                    .where('deviceCode', '==', code.toUpperCase())
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    showMessage('âŒ æ‰¾ä¸åˆ°è¯¥è®¾å¤‡ç ï¼è¯·ç¡®è®¤è®¾å¤‡ç æ˜¯å¦æ­£ç¡®ã€‚', 'error');
                    return;
                }
                
                const data = snapshot.docs[0].data();
                const remoteProgress = data.characterProgress || {};
                
                // åˆå¹¶æ¨¡å¼ï¼šä¿ç•™ä¸¤ä¸ªè®¾å¤‡ä¸­æ›´å¥½çš„å­¦ä¹ è®°å½•
                const beforeCount = Object.keys(userProgress).length;
                userProgress = mergeProgress(userProgress, remoteProgress);
                const afterCount = Object.keys(userProgress).length;
                const addedCount = afterCount - beforeCount;
                
                // ä¿å­˜åˆå¹¶åçš„æ•°æ®
                await saveUserProgress();
                
                // æ˜¾ç¤ºåˆå¹¶ç»“æœ
                const message = addedCount > 0 
                    ? `âœ… åŒæ­¥æˆåŠŸï¼åˆå¹¶äº† ${addedCount} ä¸ªæ–°å­—çš„å­¦ä¹ è®°å½•ã€‚`
                    : 'âœ… åŒæ­¥æˆåŠŸï¼å·²ä¿ç•™æ‚¨å½“å‰è®¾å¤‡ä¸­æ›´å¥½çš„å­¦ä¹ è®°å½•ã€‚';
                showMessage(message, 'success');
                updateStats();
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                showMessage('âŒ åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ==================== Utilities ====================
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function showMessage(text, type = 'info') {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            document.querySelector('.container').appendChild(msg);
            
            setTimeout(() => msg.remove(), 4000);
        }

        // ========== åŠ è¿™æ®µï¼ˆåˆ·æ–°æ•°æ®åŠŸèƒ½ï¼‰==========
            function refreshData() {
                if (confirm('ğŸ”„ This will reload fresh data from the server. Continue?\n\nè¿™å°†é‡æ–°åŠ è½½æœ€æ–°æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ')) {
                    localStorage.removeItem('lessons_cache');
                    location.reload();
                }
            }
            // ========== åˆ°è¿™é‡Œ ==========
            
// ==================== Layer 3: Tab Switching (Smart Review vs By Difficulty) ====================
document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const tab = e.target.dataset.tab;
        
        // Remove active from all Layer 3 buttons
        document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(b => {
            b.classList.remove('active');
        });
        
        // Add active to clicked button
        e.target.classList.add('active');
        
        // Hide all content first
        document.getElementById('recommendedSection').style.display = 'none';
        document.getElementById('difficultySection').style.display = 'none';
        
        // æ˜¾ç¤º/éšè—å¤ä¹ æ–¹å‘é€‰æ‹©å™¨ï¼ˆåªåœ¨è¯ç»„tabæ˜¾ç¤ºï¼‰
        const directionSelector = document.getElementById('reviewDirectionSelector');
        if (directionSelector) {
            directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
        }
        
        // Show selected content
        if (tab === 'smart-review') {
            document.getElementById('recommendedSection').style.display = 'block';
        } else if (tab === 'by-difficulty') {
            document.getElementById('difficultySection').style.display = 'block';
        }
    });
});

// é é¢è¼‰å…¥æ™‚ï¼Œé è¨­é¡¯ç¤º Smart Reviewï¼ˆä½†å±¤ 3 Tab æ‡‰è©²éš±è—ï¼Œé™¤éå±¤ 2 æœ‰é¸èª²ç¨‹ï¼‰
window.addEventListener('load', () => {
    document.getElementById('reviewMethodTabs').style.display = 'none';
    document.getElementById('recommendedSection').style.display = 'none';
    document.getElementById('difficultySection').style.display = 'none';
});

// ==================== Username Verification ====================
async function checkAndVerifyUsername() {
    // ä» localStorage è¯»å–ä¿å­˜çš„ç”¨æˆ·å
    const savedUsername = localStorage.getItem('shizi_username');
    
    if (savedUsername) {
        // è‡ªåŠ¨éªŒè¯ä¿å­˜çš„ç”¨æˆ·å
        const isValid = await verifyUsername(savedUsername);
        if (isValid) {
            username = savedUsername;
            return; // éªŒè¯é€šè¿‡ï¼Œç»§ç»­
        } else {
            // éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤ä¿å­˜çš„ç”¨æˆ·å
            localStorage.removeItem('shizi_username');
            showUsernameModal('è¯¥ç”¨æˆ·åå·²å¤±æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥');
        }
    } else {
        // æ²¡æœ‰ä¿å­˜çš„ç”¨æˆ·åï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
        showUsernameModal();
    }
}

function showUsernameModal(errorMsg = '') {
    const modal = document.getElementById('usernameModal');
    const input = document.getElementById('usernameInput');
    const errorDiv = document.getElementById('usernameError');
    
    // å¦‚æœæœ‰ä¿å­˜çš„ç”¨æˆ·åï¼Œè‡ªåŠ¨å¡«å……
    const savedUsername = localStorage.getItem('shizi_username');
    if (savedUsername) {
        input.value = savedUsername;
    }
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if (errorMsg) {
        errorDiv.textContent = 'âŒ ' + errorMsg;
        errorDiv.style.display = 'block';
    } else {
        errorDiv.style.display = 'none';
    }
    
    modal.style.display = 'flex';
    input.focus();
    
    // å…è®¸ Enter é”®æäº¤
    input.onkeypress = (e) => {
        if (e.key === 'Enter') {
            verifyAndSaveUsername();
        }
    };
}

async function verifyAndSaveUsername() {
    const input = document.getElementById('usernameInput');
    const errorDiv = document.getElementById('usernameError');
    const usernameValue = input.value.trim().toLowerCase();
    
    // æ¸…é™¤é”™è¯¯ä¿¡æ¯
    errorDiv.style.display = 'none';
    
    if (!usernameValue) {
        errorDiv.textContent = 'âŒ è¯·è¾“å…¥ç”¨æˆ·åï¼';
        errorDiv.style.display = 'block';
        return;
    }
    
    // æ£€æŸ¥æ ¼å¼ï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
    if (!/^[a-z0-9_]+$/.test(usernameValue)) {
        errorDiv.textContent = 'âŒ ç”¨æˆ·ååªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼';
        errorDiv.style.display = 'block';
        return;
    }
    
    // æ˜¾ç¤ºéªŒè¯ä¸­
    errorDiv.textContent = 'â³ æ­£åœ¨éªŒè¯...';
    errorDiv.style.color = 'var(--primary-color)';
    errorDiv.style.display = 'block';
    
    try {
        // éªŒè¯ç”¨æˆ·åæ˜¯å¦åœ¨ç™½åå•ä¸­
        const isValid = await verifyUsername(usernameValue);
        
        if (isValid) {
            // éªŒè¯é€šè¿‡
            username = usernameValue;
            localStorage.setItem('shizi_username', usernameValue);
            
            // å…³é—­ç”¨æˆ·å Modal
            document.getElementById('usernameModal').style.display = 'none';
            input.value = '';
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥ç”¨æˆ·åçš„è®°å½•
            const existingDoc = await db.collection('user_progress').doc(username).get();
            
            if (!existingDoc.exists) {
                // æ–°ç”¨æˆ·ï¼Œè¯¢é—®æ˜¯å¦è¦å¯¼å…¥æ—§æ•°æ®
                showMigrationModal();
            } else {
                // å·²æœ‰è®°å½•ï¼Œç›´æ¥åŠ è½½
                await loadLessonsFromFirebase();
                await loadUserProgress();
                updateStudentNameDisplay();
                renderLessonCheckboxes();
                document.getElementById('loadingContainer').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                updateDueInfoText();
                const directionSelector = document.getElementById('reviewDirectionSelector');
                if (directionSelector) {
                    directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
                }
                updateStats();
                updateDeviceCodeDisplay();
                checkAndShowNameModal();
                
                showMessage('âœ… ç”¨æˆ·åéªŒè¯æˆåŠŸï¼', 'success');
            }
        } else {
            // éªŒè¯å¤±è´¥
            errorDiv.textContent = 'âŒ è¯¥ç”¨æˆ·åä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼Œè¯·è”ç³»è€å¸ˆï¼';
            errorDiv.style.color = 'var(--danger-color)';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('éªŒè¯ç”¨æˆ·åå¤±è´¥:', error);
        errorDiv.textContent = 'âŒ éªŒè¯å¤±è´¥ï¼š' + error.message;
        errorDiv.style.color = 'var(--danger-color)';
        errorDiv.style.display = 'block';
    }
}

async function verifyUsername(usernameToCheck) {
    try {
        const doc = await db.collection('allowed_users').doc(usernameToCheck).get();
        
        if (!doc.exists) {
            return false; // ç”¨æˆ·åä¸å­˜åœ¨
        }
        
        const data = doc.data();
        if (data.isActive === false) {
            return false; // ç”¨æˆ·åå·²åœç”¨
        }
        
        return true; // éªŒè¯é€šè¿‡
    } catch (error) {
        console.error('éªŒè¯ç”¨æˆ·åæ—¶å‡ºé”™:', error);
        return false;
    }
}

// ==================== Data Migration ====================
function showMigrationModal() {
    const modal = document.getElementById('migrationModal');
    const input = document.getElementById('migrationDeviceCode');
    const errorDiv = document.getElementById('migrationError');
    
    errorDiv.style.display = 'none';
    modal.style.display = 'flex';
    input.value = '';
    input.focus();
    
    // å…è®¸ Enter é”®æäº¤
    input.onkeypress = (e) => {
        if (e.key === 'Enter') {
            migrateFromDeviceCode();
        }
    };
}

function skipMigration() {
    // è·³è¿‡è¿ç§»ï¼Œåˆ›å»ºæ–°è®°å½•
    document.getElementById('migrationModal').style.display = 'none';
    initializeAfterMigration();
}

async function migrateFromDeviceCode() {
    const input = document.getElementById('migrationDeviceCode');
    const errorDiv = document.getElementById('migrationError');
    const deviceCodeValue = input.value.trim().toUpperCase();
    
    // æ¸…é™¤é”™è¯¯ä¿¡æ¯
    errorDiv.style.display = 'none';
    
    if (!deviceCodeValue) {
        errorDiv.textContent = 'âŒ è¯·è¾“å…¥è®¾å¤‡ç ï¼';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (deviceCodeValue.length !== 6) {
        errorDiv.textContent = 'âŒ è®¾å¤‡ç åº”ä¸º6ä½ï¼';
        errorDiv.style.display = 'block';
        return;
    }
    
    // æ˜¾ç¤ºæŸ¥æ‰¾ä¸­
    errorDiv.textContent = 'â³ æ­£åœ¨æŸ¥æ‰¾è®¾å¤‡è®°å½•...';
    errorDiv.style.color = 'var(--primary-color)';
    errorDiv.style.display = 'block';
    
    try {
        // æŸ¥æ‰¾è¯¥ deviceCode çš„æ‰€æœ‰è®°å½•
        const snapshot = await db.collection('user_progress')
            .where('deviceCode', '==', deviceCodeValue)
            .get();
        
        if (snapshot.empty) {
            errorDiv.textContent = 'âŒ æ‰¾ä¸åˆ°è¯¥è®¾å¤‡ç çš„è®°å½•ï¼è¯·ç¡®è®¤è®¾å¤‡ç æ˜¯å¦æ­£ç¡®ï¼Œæˆ–é€‰æ‹©"è·³è¿‡"åˆ›å»ºæ–°è®°å½•ã€‚';
            errorDiv.style.color = 'var(--danger-color)';
            errorDiv.style.display = 'block';
            return;
        }
        
        // æ‰¾åˆ°è®°å½•ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªï¼ˆå¦‚æœæœ‰å¤šä¸ªï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªï¼‰
        const oldDoc = snapshot.docs[0];
        const oldData = oldDoc.data();
        const oldUserId = oldDoc.id;
        
        // åˆå¹¶è¿›åº¦æ•°æ®ï¼ˆä½¿ç”¨ä¹‹å‰çš„åˆå¹¶é€»è¾‘ï¼‰
        const oldProgress = oldData.characterProgress || {};
        userProgress = mergeProgress(userProgress, oldProgress);
        
        // å¦‚æœæœ‰å­¦ç”Ÿå§“åï¼Œä¹Ÿä¿ç•™
        if (oldData.studentName && !studentName) {
            studentName = oldData.studentName;
        }
        
        // ä¿å­˜åˆ°æ–°ä½ç½®ï¼ˆä½¿ç”¨ç”¨æˆ·åä½œä¸ºæ–‡æ¡£IDï¼‰
        await db.collection('user_progress').doc(username).set({
            characterProgress: userProgress,
            lastReview: oldData.lastReview || new Date().toISOString(),
            deviceCode: deviceCode,
            studentName: studentName,
            username: username,
            migratedFrom: oldUserId, // è®°å½•è¿ç§»æ¥æº
            migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // æ ‡è®°æ—§è®°å½•ä¸ºå·²è¿ç§»
        await db.collection('user_progress').doc(oldUserId).update({
            migratedTo: username,
            migratedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // å…³é—­ Modal
        document.getElementById('migrationModal').style.display = 'none';
        input.value = '';
        
        // åˆå§‹åŒ–é¡µé¢
        initializeAfterMigration();
        
        showMessage('âœ… æ•°æ®è¿ç§»æˆåŠŸï¼å·²ä»æ—§è®¾å¤‡å¯¼å…¥å­¦ä¹ è®°å½•ã€‚', 'success');
    } catch (error) {
        console.error('è¿ç§»å¤±è´¥:', error);
        errorDiv.textContent = 'âŒ è¿ç§»å¤±è´¥ï¼š' + error.message;
        errorDiv.style.color = 'var(--danger-color)';
        errorDiv.style.display = 'block';
    }
}

async function initializeAfterMigration() {
    // åŠ è½½è¯¾ç¨‹æ•°æ®
    await loadLessonsFromFirebase();
    await loadUserProgress();
    updateStudentNameDisplay();
    renderLessonCheckboxes();
    document.getElementById('loadingContainer').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    updateDueInfoText();
    const directionSelector = document.getElementById('reviewDirectionSelector');
    if (directionSelector) {
        directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
    }
    updateStats();
    updateDeviceCodeDisplay();
    checkAndShowNameModal();
    
    showMessage('âœ… ç”¨æˆ·åéªŒè¯æˆåŠŸï¼', 'success');
}

// ==================== Display Updates ====================
function updateDeviceCodeDisplay() {
    const deviceCodeElement = document.getElementById('deviceCode');
    if (deviceCodeElement) {
        if (username) {
            deviceCodeElement.textContent = `${deviceCode} (${username})`;
        } else {
            deviceCodeElement.textContent = deviceCode;
        }
    }
}

// ==================== Student Name Management ====================
function updateStudentNameDisplay() {
    const displayElement = document.getElementById('studentNameDisplay');
    const btnTextElement = document.getElementById('editNameBtnText');

    if (studentName && studentName.trim() !== '') {
        displayElement.textContent = studentName;
        if (btnTextElement) btnTextElement.textContent = 'Edit Name';
    } else {
        displayElement.textContent = 'Not set';
        if (btnTextElement) btnTextElement.textContent = 'Set Name';
    }
    
    // åŒæ—¶æ›´æ–° deviceCode æ˜¾ç¤ºï¼ˆåŒ…å«ç”¨æˆ·åï¼‰
    updateDeviceCodeDisplay();
}

function checkAndShowNameModal() {
    // Show modal if student name is not set
    if (!studentName || studentName.trim() === '') {
        const modal = document.getElementById('nameModal');
        modal.style.display = 'flex';
    }
}

function editStudentName() {
    const modal = document.getElementById('nameModal');
    const input = document.getElementById('studentNameInput');
    input.value = studentName || '';
    modal.style.display = 'flex';
    input.focus();
}

async function saveStudentName() {
    const input = document.getElementById('studentNameInput');
    const name = input.value.trim();

    if (name) {
        studentName = name;
        await saveUserProgress();
        updateStudentNameDisplay();
        showMessage('Name saved successfully! å§“åä¿å­˜æˆåŠŸï¼', 'success');
    }

    closeNameModal();
}

function skipNameInput() {
    closeNameModal();
}

function closeNameModal() {
    const modal = document.getElementById('nameModal');
    modal.style.display = 'none';
    document.getElementById('studentNameInput').value = '';
}

// Allow Enter key to submit name
document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('studentNameInput');
    if (input) {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveStudentName();
            }
        });
    }
});

    </script>
    <script src="../../assets/js/nav-global.js"></script>
</body>
</html>