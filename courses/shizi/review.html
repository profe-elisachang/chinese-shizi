<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Character Review System - Cloud Sync</title>
    <link rel="stylesheet" href="../../assets/css/nav-global.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

   <style>
    
    :root {
        /* ‰∏ªËâ≤Ë∞ÉÔºöÊ∏ÖÁàΩÊµ∑Ê¥ãËìùÁªøÔºàÁ∫ØËâ≤ÔºÅÊó†Ê∏êÂèòÔºâ */
        --primary: #00acc1;      /* ‰∏ªËìùÁªø cyan-600 */
        --primary-dark: #0589aa; /* Ê∑±ËìùÁªø cyan-900 */
        --primary-light: #b2ebf2; /* ÊµÖËìùÁªø cyan-300ÔºàÁî®‰∫éÊµÖËÉåÊôØÔºâ */
        
        /* ËæÖÂä©Ëâ≤ */
        --success: #4caf50;
        --danger: #ef4444;
        
        /* ‰∏≠ÊÄßËâ≤ */
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --bg-page: #ffffff;       /* Á∫ØÁôΩ‰∏ªËÉåÊôØ */
        --bg-card: #ffffff;
        --bg-hover: #f0fdfd;      /* ÊûÅÊµÖËìùÁªøÊÇ¨ÂÅú */
        --bg-light: #ecfdfd;      /* ÊµÖËìùÁªøËÉåÊôØÂùó */
        --border: #b2ebf2;
        --shadow: rgba(0, 105, 115, 0.12);
        
/* Leitner ÁõíÂ≠êÁ∫ØËâ≤ÔºàÊó†Ê∏êÂèòÔºâ */
--forgot: #ef4444;
--hard: #d97706;
--good: #059669;
--easy: #0891b2;

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
    body { background: linear-gradient(135deg, #f0f9fa 0%, #e0f7fa 100%); color: var(--text-primary); min-height: 100vh; }

    /* Top Navigation styles are now in nav-global.css */

    .container {
        max-width: 1000px;
        margin: 20px auto;
        background: var(--bg-card);
        border-radius: 20px;
        box-shadow: 0 10px 40px var(--shadow);
        padding: 24px;
        border: 1px solid #e0f7fa;
    }

    @media (max-width: 640px) {
        .container {
            margin: 10px;
            padding: 16px;
            border-radius: 16px;
        }
    }

    /* ==================== Header ==================== */
    header { text-align: center; margin-bottom: 32px; }
    h1 { color: var(--primary-dark); font-size: 2.3rem; font-weight: 700; margin-bottom: 8px; }
    .subtitle { color: var(--text-secondary); font-size: 1.1rem; }

    @media (max-width: 640px) {
        header { margin-bottom: 20px; }
        h1 { font-size: 1.6rem; }
        .subtitle { font-size: 0.95rem; }
    }
    
    .device-code-display {
        margin-top: 20px;
        padding: 16px 24px;
        background: var(--bg-light);
        border-radius: 14px;
        display: inline-block;
        border: 1px solid var(--border);
        min-width: 280px;
    }
    .device-code-display strong {
        color: var(--primary);
        font-size: 1.8rem;
        letter-spacing: 4px;
        font-weight: bold;
    }

    @media (max-width: 640px) {
        .device-code-display {
            min-width: auto;
            padding: 12px 16px;
        }
        .device-code-display strong {
            font-size: 1.3rem;
            letter-spacing: 2px;
        }
    }

    /* ==================== Loading ==================== */
    .loader {
        border: 5px solid #f0f7fa;
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        width: 50px; height: 50px;
        animation: spin 1s linear infinite;
        margin: 40px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ==================== Tab System ==================== */
    .tab-system { margin: 24px 0; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px var(--shadow); }
    .tab-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; background: var(--bg-light); }
    .tab-btn {
        padding: 18px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
    }
    .tab-btn:hover { background: rgba(0,172,193,0.15); color: var(--primary); }
    .tab-btn.active { color: var(--primary); background: white; }
    .tab-btn.active::after {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
        background: var(--primary);
    }

    @media (max-width: 640px) {
        .tab-system { margin: 16px 0; }
        .tab-btn {
            padding: 14px 8px;
            font-size: 0.95rem;
        }
    }

    /* ==================== Lesson Selection ==================== */
   /* ==================== Lesson Selection - Modern Card Style (ÊñπÊ°à C) ==================== */
.lesson-selector {
    background: transparent;
    box-shadow: none;
    border: none;
    padding: 0;
    margin: 32px 0;
}

.selector-header {
    background: var(--primary);
    color: white;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0,172,193,0.28);
    padding: 20px 28px;
    margin-bottom: 16px;
    font-size: 1.3rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.selector-header:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.selector-content {
    background: white;
    border-radius: 20px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    padding: 24px 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, 110px);
    justify-content: center;
    gap: 16px;
    max-height: none;
    overflow-y: visible;
    overflow-x: hidden;
    transition: all 0.4s ease;
}

@media (max-width: 640px) {
    .selector-content {
        grid-template-columns: repeat(3, 1fr);
        max-height: 360px;
        overflow-y: auto;
        padding: 16px 12px;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .selector-content {
        grid-template-columns: repeat(2, 1fr);
    }
}

.selector-content.collapsed {
    display: none;
    max-height: 0;
    padding: 0;
    overflow: hidden;
}

#lessonCheckboxes {
    display: contents; /* ËÆ©Â≠êÂÖÉÁ¥†Áõ¥Êé•ÂèÇ‰∏éÁà∂Á∫ßÁöÑ grid Â∏ÉÂ±Ä */
}

.lesson-checkbox {
    background: #f8fdff;
    border: 2px solid transparent;
    border-radius: 16px;
    padding: 18px 22px;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.lesson-checkbox:hover {
    background: var(--bg-hover);
    border-color: var(--primary-light);
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0,172,193,0.18);
}

.lesson-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    margin-right: 16px;
    accent-color: var(--primary);
    cursor: pointer;
}

.lesson-info {
    font-weight: 600;
    font-size: 1.1rem;
    flex: 1;
}

.lesson-count {
    color: var(--text-muted);
    font-size: 0.95rem;
    background: rgba(0,172,193,0.15);
    padding: 4px 12px;
    border-radius: 20px;
}

/* ==================== Circle Cards (Grid Layout) ==================== */
.circle-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 12px;
    border-radius: 16px;
}

.circle-card:hover:not(.locked) {
    transform: translateY(-4px);
}

.circle-card.locked {
    cursor: not-allowed;
    opacity: 0.5;
}

/* Circle Progress Ring */
.circle-progress {
    position: relative;
    width: 100px;
    height: 100px;
}

.progress-ring {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.progress-ring-bg {
    fill: none;
    stroke: #e0e0e0;
    stroke-width: 6;
}

.progress-ring-circle {
    fill: none;
    stroke: var(--primary);
    stroke-width: 6;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;
}

/* Selected state - fill the circle */
.circle-card[data-selected="true"] .progress-ring-circle {
    stroke: var(--primary);
}

.circle-card[data-selected="true"] .circle-content {
    background: var(--primary);
    color: white;
}

.circle-card[data-selected="true"] .progress-text,
.circle-card[data-selected="true"] .char-count {
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.circle-card[data-selected="true"] .circle-label {
    color: var(--primary);
    font-weight: 700;
}
/* Circle Content (center of the ring) */
.circle-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.lesson-num {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
}

.progress-text {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary);
}

.circle-card[data-selected="true"] .lesson-num,
.circle-card[data-selected="true"] .progress-text {
    color: white;
}

/* Lock icon for coming soon */
.lock-icon {
    font-size: 2rem;
}

/* Labels below circle */
.circle-label {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    text-align: center;
}

.circle-sublabel {
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-align: center;
}

@media (max-width: 640px) {
    .circle-progress {
        width: 80px;
        height: 80px;
    }

    .circle-content {
        width: 64px;
        height: 64px;
    }

    .progress-text {
        font-size: 1.1rem;
    }

    .circle-label {
        font-size: 0.85rem;
    }
}



.selector-actions {
    padding: 20px 0 0;
    display: flex;
    gap: 16px;
    justify-content: center;
    background: transparent;
    border-top: none;
}

@media (max-width: 640px) {
    .selector-actions {
        flex-direction: column;
        gap: 10px;
        padding: 16px 0 0;
    }
    .selector-actions .btn {
        width: 100%;
    }
}
    /* ==================== Smart Recommendation ==================== */
    .recommended-section {
        background: var(--primary-light);   /* Á∫ØËâ≤ÊµÖËìùÁªø */
        border-radius: 20px;
        padding: 32px;
        margin: 32px 0;
        box-shadow: 0 10px 35px rgba(0,172,193,0.22);
        transition: 0.3s;
        cursor: pointer;
        border: 1px solid var(--border);
    }

    @media (max-width: 640px) {
        .recommended-section {
            padding: 20px 16px;
            margin: 20px 0;
            border-radius: 16px;
        }
    }

            /* ÊéßÂà∂ Smart Review Âíå By Difficulty ÁöÑÈ°ØÁ§∫/Èö±Ëóè */
        #recommendedSection {
            display: none;  /* È†êË®≠Èö±Ëóè */
        }

        #recommendedSection.show {
            display: block;  /* Tab ÈªûÈÅ∏ÊôÇÈ°ØÁ§∫ */
        }

        #difficultySection {
            display: none;  /* È†êË®≠Èö±Ëóè */
        }

        #difficultySection.show {
            display: block;  /* Tab ÈªûÈÅ∏ÊôÇÈ°ØÁ§∫ */
        }
    .recommended-section:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(0,172,193,0.28); }
    
    .recommended-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .recommended-title-group { display: flex; align-items: center; gap: 14px; }
    .recommended-icon { font-size: 36px; }
    .recommended-title { font-size: 26px; font-weight: 700; color: var(--primary-dark); }
    .collapse-arrow { font-size: 1.8rem; transition: 0.3s; color: var(--primary-dark); }
    .recommended-section.collapsed .collapse-arrow { transform: rotate(180deg); }
    .recommended-section.collapsed .recommended-content { display: none; }

    .recommended-subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 24px; font-size: 15px; }

    @media (max-width: 640px) {
        .recommended-icon { font-size: 28px; }
        .recommended-title { font-size: 1.3rem; }
        .recommended-subtitle { font-size: 0.85rem; margin-bottom: 16px; }
        .recommended-header { margin-bottom: 16px; }
    }
    .due-info {
        text-align: center;
        background: white;
        padding: 16px;
        border-radius: 14px;
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-dark);
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .recommended-breakdown {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
        margin: 28px 0;
    }
        .breakdown-item {
            background: white;
            padding: 18px;
            border-radius: 14px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 3px solid var(--border); /* È¢ÑËÆæËæπÊ°Ü */
        }
    .breakdown-item.forgot { background: white; color: var(--text-primary); border: 3px solid var(--forgot); }
    .breakdown-item.hard   { background: white; color: var(--text-primary); border: 3px solid var(--hard); }
    .breakdown-item.good   { background: white; color: var(--text-primary); border: 3px solid var(--good); }
    .breakdown-item.easy   { background: white; color: var(--text-primary); border: 3px solid var(--easy); }
   .breakdown-count { font-size: 36px; font-weight: bold; }
    .breakdown-label { font-size: 14px; color: var(--text-secondary); }

    @media (max-width: 640px) {
        .recommended-breakdown {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        .breakdown-item {
            padding: 14px 10px;
        }
        .breakdown-count { font-size: 28px; }
        .breakdown-label { font-size: 0.8rem; }
    }
    
    .amount-selector { text-align: center; margin: 28px 0; }
    .amount-selector label { font-size: 17px; color: var(--text-primary); display: block; margin-bottom: 12px; }
    .amount-selector select {
        padding: 14px 20px;
        font-size: 17px;
        border: 2px solid var(--primary);
        border-radius: 14px;
        background: white;
        color: var(--primary-dark);
        min-width: 320px;
        cursor: pointer;
    }

    @media (max-width: 640px) {
        .amount-selector { margin: 20px 0; }
        .amount-selector label { font-size: 0.95rem; }
        .amount-selector select {
            min-width: auto;
            width: 100%;
            max-width: 100%;
            padding: 12px 16px;
            font-size: 0.9rem;
        }
    }
    
    .recommended-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 18px 48px;
        border-radius: 30px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: block;
        margin: 0 auto;
        box-shadow: 0 8px 25px rgba(0,172,193,0.35);
        transition: 0.3s;
    }
    .recommended-btn:hover { background: var(--primary-dark); transform: translateY(-4px); }

    @media (max-width: 640px) {
        .recommended-btn {
            padding: 14px 32px;
            font-size: 1rem;
        }
    }

    /* ==================== Mastery Boxes ==================== */
    .mastery-boxes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
        margin: 32px 0;
    }
    @media (min-width: 768px) { .mastery-boxes { grid-template-columns: repeat(4, 1fr); } }
    
    .mastery-box {
        background:transparent;
        border-radius: 20px;
        padding: 32px 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        border: 3px solid rgba(0,0,0,0.1);;
    }
    .mastery-box.forgot { background: var(--forgot); }
    .mastery-box.hard   { background: var(--hard); }
    .mastery-box.good   { background: var(--good); }
    .mastery-box.easy   { background: var(--easy); }
    
    .mastery-box:hover { transform: translateY(-8px); box-shadow: 0 14px 30px rgba(0,0,0,0.18); }
    
    .box-title { font-size: 18px; font-weight: 600; color: #ffffff; margin-bottom: 8px; }
    .box-count { font-size: 42px; font-weight: bold; color: #ffffff; margin: 12px 0; }
    .box-description { font-size: 14px; color:#ffffff; }

    @media (max-width: 640px) {
        .mastery-box {
            padding: 24px 16px;
        }
        .box-title { font-size: 1rem; }
        .box-count { font-size: 32px; }
        .box-description { font-size: 0.8rem; }
    }

    /* ==================== Review Area (‰Ω†ÂéüÊú¨ÁöÑÂç°ÁâáÂå∫‰øùÊåÅÂÆåÁæé) ==================== */
    .review-area { text-align: center; margin: 30px 0; }
    .current-session { font-size: 20px; color: var(--text-secondary); font-weight: bold; margin: 20px 0; }

    .card {
        perspective: 1000px;
        height: 600px;
        margin: 20px auto;
        cursor: pointer;
        max-width: 700px;
        width: 100%;
    }

    @media (max-width: 640px) {
        .review-area { margin: 20px 0; }
        .current-session { font-size: 1.1rem; margin: 16px 0; }
        .card {
            height: 550px;
            margin: 16px auto;
        }
    }
    .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    
    .card-front, .card-back {
        position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
        border-radius: 20px; padding: 24px; display: flex; flex-direction: column;
        justify-content: flex-start; align-items: center; box-shadow: 0 10px 30px var(--shadow);
        overflow-y: auto;
    }

    @media (max-width: 640px) {
        .card-front, .card-back {
            padding: 16px 12px;
            justify-content: flex-start;
            overflow-y: auto;
        }
    }
    .card-front { background: white; border: 3px solid var(--border); }
    .card-back { background: var(--bg-light); border: 3px solid var(--primary); transform: rotateY(180deg); }

    .character { 
        font-size: 140px; 
        color: var(--primary-dark); 
        font-weight: bold;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
        max-width: 100%;
        text-align: center;
        line-height: 1.2;
    }
    .character.english-text {
        /* Ëã±ÊñáÊñáÊú¨‰ΩøÁî®ËæÉÂ∞èÂ≠ó‰ΩìÔºåÊîØÊåÅÊç¢Ë°å */
        font-size: clamp(30px, 8vw, 80px);
        line-height: 1.3;
    }
    .back-character { font-size: 80px; color: var(--primary-dark); }
    .pinyin { font-size: 30px; color: var(--primary); margin: 10px 0; font-weight: bold; }
    .meaning { font-size: 22px; color: var(--text-primary); line-height: 1.5; }

    @media (max-width: 640px) {
        .character { 
            font-size: 100px;
        }
        .character.english-text {
            font-size: clamp(24px, 6vw, 60px);
        }
        .back-character { font-size: 50px; }
        .pinyin { font-size: 20px; margin: 6px 0; }
        .meaning { font-size: 1rem; }
    }
        .meaning {
            font-size: 20px;
            color: var(--secondary-color);
            line-height: 1.4;
            margin: 8px 0;
        }
        
        .card-image {
            max-width: 100%;
            max-height: 300px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            margin: 12px 0;
        }

        @media (max-width: 640px) {
            .card-image {
                max-height: 150px;
            }
        }
        
        .card-content {
            text-align: left;
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            margin-top: 8px;
        }
        
        .content-label {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        /* ==================== Markdown Image Styles (Alt-based) ==================== */
        .card-content img.img-comp {
            height: 1.8em;
            width: auto;
            display: inline-block;
            vertical-align: middle;
            margin: 0 4px;
        }
        
        .card-content img.img-origin {
            max-width: 100%;
            height: 200px;
            object-fit: contain;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 8px;
            display: block;
            margin: 12px auto;
        }
        
        .card-content img.img-story {
            max-width: 100%;
            height: 250px;
            object-fit: contain;
            border-radius: 8px;
            display: block;
            margin: 12px auto;
        }
        
        .phrase-example-section {
            width: 100%;
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-md);
            border-top: 2px solid var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        
        .phrase-example-title {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--primary-dark);
            margin-bottom: var(--spacing-sm);
            text-align: center;
        }
        
        .phrase-example-item {
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-sm);
        }
        
        .phrase-example-label {
            font-weight: var(--font-semibold);
            margin-bottom: var(--spacing-xs);
        }
        
        .phrase-example-text {
            font-size: var(--text-base);
            line-height: 1.6;
        }

        /* Ë©ûÁµÑ‰æãÂè• Markdown ÂàóË°®Ê®£Âºè */
        .phrase-example-text ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            list-style: decimal;
        }

        .phrase-example-text li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .phrase-example-text strong {
            font-weight: 700;
        }

        .phrase-example-text em {
            font-style: italic;
        }
        
        .speak-btn {
            background: var(--primary-dark);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 0;
            transition: all 0.3s;
        }

        .speak-btn:hover {
            background: var(--success);
        }

        @media (max-width: 640px) {
            .speak-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
                margin: 6px 0;
            }
        }
    .review-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        max-width: 600px;
        margin: 30px auto;
    }
    @media (min-width: 768px) { .review-buttons { grid-template-columns: repeat(4, 1fr); } }

    .review-btn {
        padding: 18px;
        border: none;
        border-radius: 16px;
        font-weight: bold;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
    }
    .btn-forgot { background: var(--forgot); }
    .btn-hard   { background: var(--hard); }
    .btn-good   { background: var(--good); }
    .btn-easy   { background: var(--easy); }
    .review-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }

    @media (max-width: 640px) {
        .review-buttons {
            gap: 12px;
            margin: 20px auto;
        }
        .review-btn {
            padding: 14px 8px;
            font-size: 0.9rem;
        }
    }

    /* Progress Bar */
    .progress-bar {
        height: 36px;
        background: var(--bg-light);
        border-radius: 18px;
        overflow: hidden;
        margin: 24px 0;
        border: 2px solid var(--border);
    }
    .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
    }

    /* Buttons */
    .btn {
        padding: 12px 28px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: #94a3b8; color: white; }

    @media (max-width: 640px) {
        .btn {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
    }

    /* Messages & Data Section */
    .message { padding: 18px; border-radius: 14px; margin: 20px 0; text-align: center; font-weight: bold; }
    .message.success { background: #d1fae5; color: #065f46; border: 1px solid #34d399; }
    .message.error { background: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
    .message.info { background: #dbeafe; color: #1e40af; border: 1px solid #60a5fa; }
    .message.warning { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; }

    .data-section {
        margin: 32px 0 16px;
        padding: 24px;
        background: var(--bg-light);
        border-radius: 16px;
        border: 1px solid var(--border);
    }
    .data-section h3 { color: var(--primary-dark); margin-bottom: 16px; font-size: 1.3rem; }
    .data-actions { display: flex; flex-wrap: wrap; gap: 14px; justify-content: flex-start; }

    @media (max-width: 640px) {
        .data-section {
            margin: 20px 0 12px;
            padding: 16px;
        }
        .data-section h3 { font-size: 1.1rem; margin-bottom: 12px; }
        .data-actions {
            gap: 10px;
        }
    }

    .hidden { display: none !important; }


       /* Data Management */
        .data-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--bg-light);
            border-radius: 12px;
        }
        
        .data-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .data-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .mastery-boxes {
                grid-template-columns: repeat(4, 1fr);
            }

            .review-buttons {
                grid-template-columns: repeat(4, 1fr);
            }

            .character {
                font-size: 150px;
            }
        }

        @media (max-width: 480px) {
            .character {
                font-size: 80px;
            }

            .card {
                height: 500px;
            }

            .card-image {
                max-height: 100px;
            }

            .back-character {
                font-size: 38px;
            }

            .pinyin {
                font-size: 16px;
            }

            .meaning {
                font-size: 0.85rem;
            }

            .card-content {
                padding: 6px;
                font-size: 0.8rem;
            }
        }
</style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <!-- Desktop Navigation -->
        <div class="nav-content">
            <a href="../../index.html" class="nav-link">Home</a>
            <span class="nav-separator">|</span>
            <a href="../bct/lessons/lesson.html" class="nav-link">Lessons</a>
            <span class="nav-separator">|</span>
            <a href="lesson.html" class="nav-link">Literacy</a>
            <span class="nav-separator">|</span>
            <a href="review.html" class="nav-link active">Review Lit.</a>
            <span class="nav-separator group-separator">‚Ä¢</span>
            <a href="../../pages/grammar.html" class="nav-link">Grammar</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/extras.html" class="nav-link">Extras</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/mini-story.html" class="nav-link">Mini Story</a>
            <span class="nav-separator">|</span>
            <a href="../../pages/music.html" class="nav-link">Music</a>
            <span class="nav-separator group-separator">‚Ä¢</span>
            <a href="../../pages/timeline.html" class="nav-link">Timeline</a>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <button class="hamburger-btn" aria-label="Open menu">‚ò∞</button>
            <span class="site-title">Chinese with Elisa</span>
        </div>
    </nav>

    <!-- Mobile Sidebar -->
    <div class="mobile-sidebar">
        <button class="close-sidebar" aria-label="Close menu">‚úï</button>

        <a href="../../index.html" class="mobile-menu-single">
            <span class="icon">üè†</span>
            <span>Home</span>
        </a>

        <div class="mobile-menu-group">
            <div class="mobile-menu-title">
                <span class="icon">üìö</span>
                <span>Courses</span>
            </div>
            <a href="../bct/lessons/lesson.html" class="mobile-menu-item">Lessons</a>
            <a href="lesson.html" class="mobile-menu-item">Literacy</a>
            <a href="review.html" class="mobile-menu-item active">Review Lit.</a>
        </div>

        <div class="mobile-menu-group">
            <div class="mobile-menu-title">
                <span class="icon">üìñ</span>
                <span>Resources</span>
            </div>
            <a href="../../pages/grammar.html" class="mobile-menu-item">Grammar</a>
            <a href="../../pages/extras.html" class="mobile-menu-item">Extras</a>
            <a href="../../pages/mini-story.html" class="mobile-menu-item">Mini Story</a>
            <a href="../../pages/music.html" class="mobile-menu-item">Music</a>
        </div>

        <a href="../../pages/timeline.html" class="mobile-menu-single">
            <span class="icon">üìÖ</span>
            <span>Timeline</span>
        </a>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay"></div>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>üìö Chinese Character Review System</h1>
            <div class="subtitle">Cloud Sync ‚Ä¢ Spaced Repetition</div>
        </header>

        <!-- Loading -->
        <div id="loadingContainer">
            <div class="loader"></div>
            <p style="text-align: center; color: var(--text-secondary);">Loading...</p>
        </div>
        
        <!-- Main Content -->
        <div id="mainContent" class="hidden">
            <!-- Tab System -->
            <div class="tab-system">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="components">Radical Components</button>
                    <button class="tab-btn" data-tab="characters">Character Lessons</button>
                    <button class="tab-btn" data-tab="phrases">ËØçÁªÑ</button>
                </div>
            </div>
            
            <!-- Lesson Selection -->
            <div class="lesson-selector">
            <div style="padding: 20px 0; font-size: 1.3rem; font-weight: bold; color: var(--text-primary);">
                üìö Select Lessons <span class="selector-count" id="selectedCount">(0/25)</span>
            </div>
            <div style="text-align: center; color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 16px; line-height: 1.5;">
                Select lessons to review the due cards<br>
                <span style="font-size: 0.85rem; opacity: 0.9;">(click multiple lessons to combine)</span>
            </div>
                <div class="selector-content" id="selectorContent">
                    <div id="lessonCheckboxes"></div>
                </div>
                <div class="selector-actions">
                    <button class="btn btn-primary" onclick="selectAllLessons()">Select All</button>
                    <button class="btn btn-secondary" onclick="clearAllLessons()">Clear All</button>
                </div>
            </div>

                        <!-- Layer 3: Review Method Tab -->
            <div class="tab-system" id="reviewMethodTabs">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="smart-review">üéØ Smart Review</button>
                    <button class="tab-btn" data-tab="by-difficulty">‚öôÔ∏è By Difficulty</button>
                </div>
            </div>
            
            <!-- Review Direction Selector (Shared by both Smart Review and By Difficulty) -->
            <div class="amount-selector" id="reviewDirectionSelector" style="display: none; margin-top: 20px;">
                <label>Review Direction:</label>
                <select id="reviewDirection">
                    <option value="forward">‰∏≠Êñá ‚Üí Ëã±Êñá (Chinese ‚Üí English)</option>
                    <option value="reverse">Ëã±Êñá ‚Üí ‰∏≠Êñá (English ‚Üí Chinese)</option>
                </select>
            </div>
            
            <!-- Smart Recommendation -->
            <div class="recommended-section" id="recommendedSection">


                <div class="recommended-header">
                    <div class="recommended-title-group">
                        <span class="recommended-icon">üéØ</span>
                        <div class="recommended-title">Smart Review Recommendation</div>
                    </div>                    
                </div>
                
                <div class="recommended-content">
                    <div class="recommended-subtitle">
                        üìÖ Spaced Repetition: Forgotten (daily) ‚Ä¢ Hard (1 day) ‚Ä¢ Good (3 days) ‚Ä¢ Easy (7 days)
                    </div>
                    
                    <div class="due-info" id="dueInfo">
                        Due Today: <span id="totalDue">0</span> <span id="dueItemType">characters</span>
                    </div>
                    
                    <div class="amount-selector">
                        <label>Select Review Amount:</label>
                        <select id="reviewAmount">
                            <option value="20">20 (Quick Daily Review)</option>
                            <option value="30">30 (Standard)</option>
                            <option value="50">50 (Intensive Practice)</option>
                            <option value="all">All Due Items (When you have time!)</option>
                        </select>
                    </div>
                    
                    <div class="recommended-breakdown" id="recommendedBreakdown"></div>
                    
                    <button class="recommended-btn" onclick="startRecommendedReview()">
                        üß† Start Smart Review
                    </button>
                </div>
            </div>
            
            <!-- Difficulty Section (By Difficulty Tab) -->
            <div id="difficultySection" style="display: none;">
                <!-- Mastery Boxes -->
                <div class="mastery-boxes" id="masteryBoxes" style="display: grid;">
                    <div class="mastery-box forgot" onclick="startBoxReview('forgot')">
                        <div class="box-title">Forgotten</div>
                        <div class="box-count" id="count-forgot">0</div>
                        <div class="box-description">Needs frequent review</div>
                    </div>
                    <div class="mastery-box hard" onclick="startBoxReview('hard')">
                        <div class="box-title">Hard</div>
                        <div class="box-count" id="count-hard">0</div>
                        <div class="box-description">Still challenging</div>
                    </div>
                    <div class="mastery-box good" onclick="startBoxReview('good')">
                        <div class="box-title">Good</div>
                        <div class="box-count" id="count-good">0</div>
                        <div class="box-description">Doing well</div>
                    </div>
                    <div class="mastery-box easy" onclick="startBoxReview('easy')">
                        <div class="box-title">Easy</div>
                        <div class="box-count" id="count-easy">0</div>
                        <div class="box-description">Mastered</div>
                    </div>
                </div>
            </div>
            
            <!-- Review Area -->
            <div class="review-area hidden" id="reviewArea">
                <div class="current-session" id="currentSession">Review in Progress</div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                    </div>
                    <div class="progress-text" id="progressText">0/0 Reviewed</div>
                </div>
                
                <div class="card" id="card">
                    <div class="card-inner">
                        <div class="card-front">
                            <div class="character" id="character">‰∏Ä</div>
                            <div style="margin-top: 20px; color: var(--text-secondary);">Click to flip</div>
                        </div>
                        <div class="card-back">
                            <div class="back-character" id="backCharacter">‰∏Ä</div>
                            <div class="pinyin" id="pinyin">yƒ´</div>
                            <button class="speak-btn" onclick="speakPinyin(event)">üîä Read</button>
                            <div class="meaning" id="meaning">one</div>
                            
                            <!-- Phrase Example Section -->
                            <div id="phraseExampleSection" class="phrase-example-section hidden">
                                <div class="phrase-example-title">üìñ ‰æãÂè•</div>
                                <div id="phraseExampleContent"></div>
                            </div>
                            
                            <img id="cardImage" class="card-image hidden">
                            <div id="cardBookExplanation" class="card-content hidden">
                                <div class="content-label">üìñ Ëß£Èáä:</div>
                                <div id="bookExplanationContent"></div>
                            </div>
                            <div id="cardStory" class="card-content hidden">
                                <div class="content-label">ËÆ∞ÂøÜÊïÖ‰∫ã:</div>
                                <div id="storyContent"></div>
                            </div>
                            <div id="cardPhrases" class="card-content hidden">
                                <div class="content-label">ËØçÁªÑËåÉ‰æã:</div>
                                <div id="phrasesContent"></div>
                            </div>
                            <div style="margin-top: 12px; color: var(--text-secondary);">Click to return</div>
                        </div>
                    </div>
                </div>
                
                <div class="review-buttons">
                    <button class="review-btn btn-forgot" onclick="handleCardMove('forgot')">
                        Forgotten<br>ÂøòËÆ∞
                    </button>
                    <button class="review-btn btn-hard" onclick="handleCardMove('hard')">
                        Hard<br>Âõ∞Èöæ
                    </button>
                    <button class="review-btn btn-good" onclick="handleCardMove('good')">
                        Good<br>ËâØÂ•Ω
                    </button>
                    <button class="review-btn btn-easy" onclick="handleCardMove('easy')">
                        Easy<br>ÁÆÄÂçï
                    </button>
                </div>
                
                <button class="btn btn-secondary" onclick="endReview()" style="margin-top: 20px;">
                    End Review
                </button>
            </div>
            
            <!-- Completion Message -->
            <div id="completionMessage" class="message hidden"></div>
            
<!-- Data Management -->            
<div class="data-section">
    <h3>üìÅ Data Management</h3>
    
    <!-- ÊåâÈíÆÁªÑ -->
    <div class="data-actions">
        <button class="btn btn-primary" onclick="exportProgress()">üì• Export Progress</button>
        <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
         <button class="btn btn-secondary" onclick="showDeviceCodeInput()">üîÑ Sync Another Device</button>
        <button class="btn btn-secondary" onclick="refreshData()" style="background: white; color: var(--primary); border: 2px solid var(--primary);">
            üîÑ Refresh Data
        </button>
    </div>
    
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <!-- Device Code & Student Name Display -->
    <div style="margin-top: 20px; padding: 16px; background: rgba(0,172,193,0.1); border-radius: 10px; text-align: center;">
        <div style="margin-bottom: 8px;">
            <span style="font-size: 0.9em; color: var(--text-secondary);">Device Code:</span>
            <strong style="font-size: 1.5em; color: var(--primary); margin: 0 10px;" id="deviceCode">------</strong>
        </div>
        <div style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 12px;">
            (Enter this code on another device to sync progress)
        </div>
        <div style="margin-bottom: 8px;">
            <span style="font-size: 0.9em; color: var(--text-secondary);">Student Name:</span>
            <strong style="font-size: 1.2em; color: var(--primary-dark); margin: 0 10px;" id="studentNameDisplay">Not set</strong>
        </div>
        <button class="btn btn-secondary" onclick="editStudentName()" style="padding: 8px 20px; font-size: 0.9rem;">
            üìù <span id="editNameBtnText">Set Name</span>
        </button>
    </div>

<style>
@media (max-width: 640px) {
    .data-section > div[style*="padding: 16px"] {
        padding: 12px !important;
    }
    .data-section > div[style*="padding: 16px"] span {
        font-size: 0.8rem !important;
    }
    .data-section > div[style*="padding: 16px"] strong {
        font-size: 1.2em !important;
        display: block;
        margin: 8px 0 !important;
    }
}
</style>
    
    
    <!-- ËØ¥ÊòéÊñáÂ≠ó -->
    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 14px; line-height: 1.5; text-align: center;" class="sync-info">
        üí° Your progress is automatically synced to the cloud.<br>
        To continue on another device, simply enter the Device Code shown above.
    </div>

<style>
@media (max-width: 640px) {
    .sync-info {
        font-size: 0.75rem !important;
    }
}
</style>
</div>
            </div>
        </div> <!-- end of #mainContent -->
    </div> <!-- end of .container -->

    <!-- Username Modal -->
    <div id="usernameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <h2 style="color: var(--primary-dark); font-size: 2rem; margin-bottom: 8px;">Enter Username üë§</h2>
                <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 1.6;">
                    Please enter your username to access the learning system<br>
                    <small style="color: var(--text-muted);">(Username provided by teacher)</small>
                </p>
            </div>

            <input type="text" id="usernameInput" placeholder="Enter username (e.g., zhangwei)"
                   style="width: 100%; padding: 14px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 12px; text-transform: lowercase;"
                   autocomplete="off">
            
            <div id="usernameError" style="color: var(--danger-color); font-size: 0.9em; margin-bottom: 12px; min-height: 20px; display: none;"></div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="verifyAndSaveUsername()" style="flex: 1;">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Migration Modal (import data from old device) -->
    <div id="migrationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <h2 style="color: var(--primary-dark); font-size: 2rem; margin-bottom: 8px;">ÂØºÂÖ•ÊóßËÆæÂ§áÊï∞ÊçÆÔºü üì•</h2>
                <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 1.6;">
                    ÊÇ®ÊòØÂê¶Ë¶Å‰ªéÊóßËÆæÂ§áÂØºÂÖ•Â≠¶‰π†ËÆ∞ÂΩïÔºü<br>
                    <small style="color: var(--text-muted);">ËØ∑ËæìÂÖ•ÊóßËÆæÂ§áÁöÑËÆæÂ§áÁ†Å</small>
                </p>
            </div>

            <input type="text" id="migrationDeviceCode" placeholder="ËæìÂÖ•ÊóßËÆæÂ§áÁ†ÅÔºà6‰ΩçÔºåÂ¶ÇÔºöABC123Ôºâ"
                   style="width: 100%; padding: 14px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 12px; text-transform: uppercase;"
                   autocomplete="off" maxlength="6">
            
            <div id="migrationError" style="color: var(--danger-color); font-size: 0.9em; margin-bottom: 12px; min-height: 20px; display: none;"></div>

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="skipMigration()" style="flex: 1;">Ë∑≥ËøáÔºåÂàõÂª∫Êñ∞ËÆ∞ÂΩï</button>
                <button class="btn btn-primary" onclick="migrateFromDeviceCode()" style="flex: 1;">ÂØºÂÖ•Êï∞ÊçÆ</button>
            </div>
        </div>
    </div>
    
    <!-- Student Name Modal (for display name, optional) -->
    <div id="nameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="text-align: center; margin-bottom: 24px;">
                <h2 style="color: var(--primary-dark); font-size: 2rem; margin-bottom: 8px;">Welcome! üëã</h2>
                <p style="color: var(--text-secondary); font-size: 1.1rem; line-height: 1.6;">
                    Enter your name (optional, for display)
                </p>
            </div>

            <input type="text" id="studentNameInput" placeholder="Your name (optional)"
                   style="width: 100%; padding: 14px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 20px;">

            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="skipNameInput()" style="flex: 1;">Skip</button>
                <button class="btn btn-primary" onclick="saveStudentName()" style="flex: 1;">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase Configuration ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDMDTDwDP0mEXwgJdwsXVMB2IFi9Q5zfyU",
            authDomain: "shizi-with-elisa.firebaseapp.com",
            projectId: "shizi-with-elisa",
            storageBucket: "shizi-with-elisa.firebasestorage.app",
            messagingSenderId: "46368268308",
            appId: "1:46368268308:web:5847aeb7b239b16d624701"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // ==================== Global Variables ====================
        let currentUser = null;
        let deviceCode = null;
        let studentName = '';
        let username = ''; // Áî®Êà∑ÂêçÔºàÁôΩÂêçÂçïÈ™åËØÅÁî®Ôºâ
        let allCharacters = [];
        let componentCharacters = [];
        let targetCharacters = [];
        let phraseItems = [];
        let userProgress = {};
        let currentTab = 'components';
        let reviewQueue = [];
        let currentReviewIndex = 0;
        let isCardFlipped = false;
        let reviewDirection = 'forward'; // 'forward' (‰∏≠Êñá‚ÜíËã±Êñá) or 'reverse' (Ëã±Êñá‚Üí‰∏≠Êñá)
        let saveProgressTimeout = null; // Èò≤ÊäñË®àÊôÇÂô®
        let pendingSave = false; // Ê®ôË®òÊòØÂê¶ÊúâÂæÖ‰øùÂ≠òÁöÑÊõ¥Êîπ
        
        // ==================== Initialization ====================
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // Anonymous login
                await auth.signInAnonymously();
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        deviceCode = user.uid.substring(0, 6).toUpperCase();
                        // ÊòæÁ§∫ deviceCodeÔºåÂ¶ÇÊûúÁî®Êà∑ÂêçÂ∑≤ËÆæÁΩÆÔºå‰πü‰ºöÂú®È™åËØÅÂêéÊõ¥Êñ∞ÊòæÁ§∫
                        updateDeviceCodeDisplay();
                        
                        // Check and verify username first
                        await checkAndVerifyUsername();
                        
                        // Only proceed if username is verified
                        if (username) {
                            // Load data in correct order
                            await loadLessonsFromFirebase();
                            await loadUserProgress();

                            // Update student name display
                            updateStudentNameDisplay();

                            // Render with progress data
                            renderLessonCheckboxes();

                            // Show main content
                            document.getElementById('loadingContainer').classList.add('hidden');
                            document.getElementById('mainContent').classList.remove('hidden');

                            // ÂàùÂßãÂåñÊòæÁ§∫ÈÄªËæë
                            updateDueInfoText();
                            const directionSelector = document.getElementById('reviewDirectionSelector');
                            if (directionSelector) {
                                directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
                            }

                            updateStats();

                            // Check if we need to show name input modal (for display name)
                            checkAndShowNameModal();
                        }
                    }
                });
            } catch (error) {
                showMessage('ÂàùÂßãÂåñÂ§±Ë¥•: ' + error.message, 'error');
            }
        });
        
        // ==================== Save on Page Unload ====================
        // Á¢∫‰øùÂú®È†ÅÈù¢ÈóúÈñâÊôÇ‰øùÂ≠òÊâÄÊúâÂæÖ‰øùÂ≠òÁöÑÈÄ≤Â∫¶
        window.addEventListener('beforeunload', async (e) => {
            if (pendingSave && currentUser) {
                // ‰ΩøÁî®ÂêåÊ≠•ÊñπÂºè‰øùÂ≠òÔºà‰∏çÁ≠âÂæÖÂÆåÊàêÔºåÂõ†ÁÇ∫È†ÅÈù¢Âç≥Â∞áÈóúÈñâÔºâ
                // ‰ΩÜËá≥Â∞ëÂòóË©¶ÁôºÈÄÅ‰øùÂ≠òË´ãÊ±Ç
                if (saveProgressTimeout) {
                    clearTimeout(saveProgressTimeout);
                }
                // ‰ΩøÁî® sendBeacon ÊàñÁõ¥Êé•‰øùÂ≠òÔºà‰∏çÁ≠âÂæÖÔºâ
                try {
                    if (username) {
                        await db.collection('user_progress').doc(username).set({
                            characterProgress: userProgress,
                            lastReview: new Date().toISOString(),
                            deviceCode: deviceCode,
                            studentName: studentName,
                            username: username,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                } catch (error) {
                    console.error('Error saving on unload:', error);
                }
            }
        });
        
        // ==================== Markdown Ëß£ÊûêÂ∑•ÂÖ∑ ====================
        function parseSimpleMarkdown(text) {
            if (!text) return '';
            return text
                // ÊèõË°åÁ¨¶
                .replace(/\n/g, '<br>')
                // Á≤óÈ´î **text**
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                // ÊñúÈ´î *text*
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // ÊúâÂ∫èÂàóË°® 1. text
                .replace(/^(\d+)\.\s(.+)$/gm, '<li>$2</li>')
                // ÁÑ°Â∫èÂàóË°® - text
                .replace(/^[-]\s(.+)$/gm, '<li>$1</li>')
                // ÂåÖË£ùÈÄ£Á∫åÁöÑÂàóË°®È†Ö
                .replace(/(<li>.*?<\/li>\s*)+/gs, '<ul>$&</ul>');
        }
        
        // ==================== Load Lessons from Firebase ====================
        async function loadLessonsFromFirebase() {
            try {
            console.time('Loading');  // ‚Üê Âä†ËøôË°å

            // ========== Á∑©Â≠òÊ™¢Êü•ÔºàÂê´ÁâàÊú¨ÊéßÂà∂Ôºâ==========
        const CACHE_VERSION = 3;  // ÁôºÂ∏ÉÊ©üÂà∂ÁâàÊú¨ÔºàÂ¢ûÂä†phrasesÊîØÊåÅÔºâ
        const MAX_CACHE_AGE = 1000 * 60 * 30;  // 30 ÂàÜÈêòÁ∑©Â≠òÈÅéÊúü
        const cached = localStorage.getItem('lessons_cache');
        if (cached) {
            const data = JSON.parse(cached);
            const cacheAge = Date.now() - (data.cacheTime || 0);
            // Ê™¢Êü•ÁâàÊú¨ÂíåÊôÇÊïà
            if (data.version === CACHE_VERSION && cacheAge < MAX_CACHE_AGE) {
                componentCharacters = data.components;
                targetCharacters = data.targets;
                phraseItems = data.phrases || [];
                console.log('‚úÖ Loaded from cache!');
                console.timeEnd('Loading');
                return;
            } else {
                console.log('üîÑ Cache expired or version mismatch, reloading...');
                localStorage.removeItem('lessons_cache');
            }
        }
                componentCharacters = [];
                targetCharacters = [];
                phraseItems = [];
                
// Load lessons 1-25
for (let i = 1; i <= 25; i++) {
    try {
        const doc = await db.collection('lessons').doc(`lesson${i}`).get();
        if (doc.exists) {
            const data = doc.data();

            // Components - Âè™ËºâÂÖ•Â∑≤ÁôºÂ∏ÉÁöÑ (is_published !== falseÔºåundefined Ë¶ñÁÇ∫Â∑≤ÁôºÂ∏É‰ª•ÂêëÂæåÂÖºÂÆπ)
            if (data.components && data.components.length > 0) {
                data.components
                    .filter(comp => comp.is_published !== false)
                    .forEach(comp => {
                        componentCharacters.push({
                            ...comp,
                            lesson: `lesson${i}`,
                            type: 'component'
                        });
                    });
            }

            // Target characters - Âè™ËºâÂÖ•Â∑≤ÁôºÂ∏ÉÁöÑ
            if (data.target_characters && data.target_characters.length > 0) {
                data.target_characters
                    .filter(target => target.is_published !== false)
                    .forEach(target => {
                        targetCharacters.push({
                            ...target,
                            lesson: `lesson${i}`,
                            type: 'target'
                        });
                    });
            }

            // Phrases - Âè™ËºâÂÖ• subtype === 'phrase' ÁöÑË©ûÁµÑÔºàÊéíÈô§Â∞çË©±Ôºâ
            if (data.phrases && data.phrases.length > 0) {
                data.phrases
                    .filter(phrase => phrase.subtype === 'phrase')
                    .forEach(phrase => {
                        // Ëß£Êûê content: "ÂõΩÂÆ∂|gu√≥jiƒÅ|country"
                        const parts = phrase.content.split('|').map(s => s.trim());
                        const chinese = parts[0] || '';
                        const pinyin = parts[1] || '';
                        const english = parts[2] || '';
                        
                        // ÁîüÊàêÂîØ‰∏ÄID: lesson|ËØçÁªÑÊ±âÂ≠ó
                        const uniqueId = `lesson${i}|${chinese}`;
                        
                        phraseItems.push({
                            ...phrase,
                            chinese: chinese,
                            pinyin: pinyin,
                            english: english,
                            lesson: `lesson${i}`,
                            type: 'phrase',
                            uniqueId: uniqueId
                        });
                    });
            }
        }
    } catch (error) {
        console.log(`Lesson ${i} not found, skipping...`);
    }
}
                
                console.log(`Loaded ${componentCharacters.length} components, ${targetCharacters.length} targets, ${phraseItems.length} phrases`);
                // ========== Â≠òÁ∑©Â≠òÔºàÂê´ÁâàÊú¨ÂíåÊôÇÈñìÊà≥Ôºâ==========
                    localStorage.setItem('lessons_cache', JSON.stringify({
                        components: componentCharacters,
                        targets: targetCharacters,
                        phrases: phraseItems,
                        version: 3,  // Êõ¥Êñ∞ÁâàÊú¨ËôüÔºàÂ¢ûÂä†phrasesÊîØÊåÅÔºâ
                        cacheTime: Date.now()
                    }));
                    console.log('üíæ Saved to cache!');
                    // ========== Âà∞ËøôÈáå ==========
                 console.timeEnd('Loading');  // ‚Üê Âä†ËøôË°å
                
            } catch (error) {
                console.error('Error loading lessons:', error);
                showMessage('Âä†ËΩΩËØæÁ®ãÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        // ==================== Reset Layer 3 ====================
        function resetLayer3() {
            document.getElementById('reviewMethodTabs').style.display = 'none';
            document.getElementById('recommendedSection').style.display = 'none';
            document.getElementById('difficultySection').style.display = 'none';
        }
        function renderLessonCheckboxes() {
        console.time('Rendering');  // ‚Üê Âä†ËøôË°å
            const container = document.getElementById('lessonCheckboxes');
            const lessons = [];
            
            for (let i = 1; i <= 25; i++) {
                const lessonId = `lesson${i}`;
                let items = [];
                if (currentTab === 'components') {
                    items = componentCharacters.filter(c => c.lesson === lessonId);
                } else if (currentTab === 'characters') {
                    items = targetCharacters.filter(c => c.lesson === lessonId);
                } else if (currentTab === 'phrases') {
                    items = phraseItems.filter(p => p.lesson === lessonId);
                }
                
                        // ‚úÖ Ë®àÁÆóÈÄ≤Â∫¶ÔºöEasy Êï∏Èáè / Á∏ΩÊï∏Èáè
        let easyCount = 0;
        if (items.length > 0) {
            easyCount = items.filter(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ‰ΩøÁî®uniqueId‰Ωú‰∏∫key
                    progress = userProgress[item.uniqueId];
                } else {
                    // ‰ΩøÁî®character‰Ωú‰∏∫key
                    progress = userProgress[item.character];
                }
                return progress && progress.box === 'easy';
            }).length;
        }
        const progress = items.length > 0 ? Math.round((easyCount / items.length) * 100) : 0;
                
                if (items.length > 0) {
                    lessons.push({ 
                        id: lessonId, 
                        num: i, 
                        count: items.length,
                        progress: progress
                    });
                } else {
                    lessons.push({ 
                        id: lessonId, 
                        num: i, 
                        count: 0, 
                        comingSoon: true 
                    });
                }
            }
            
            container.innerHTML = lessons.map(lesson => {
                const lessonType = currentTab === 'components' ? 'Components' : (currentTab === 'characters' ? 'Characters' : 'Phrases');
                
                if (lesson.comingSoon) {
                    return `
<div class="circle-card locked" data-lesson="${lesson.id}">
    <div class="circle-progress">
        <svg viewBox="0 0 120 120" class="progress-ring">
            <circle cx="60" cy="60" r="54" class="progress-ring-bg"/>
            <circle cx="60" cy="60" r="54" class="progress-ring-circle" 
                    style="stroke-dasharray: 339.292; stroke-dashoffset: 339.292"/>
        </svg>
        <div class="circle-content">
            <div class="lock-icon">üîí</div>
        </div>
    </div>
    <div class="circle-label">Lesson ${lesson.num}</div>

</div>`;
                } else {
                    const circumference = 2 * Math.PI * 54;
                    const offset = circumference - (lesson.progress / 100) * circumference;
                    
                    return `
<div class="circle-card" data-lesson="${lesson.id}" data-selected="false" onclick="toggleLessonSelection('${lesson.id}')">
    <div class="circle-progress">
        <svg viewBox="0 0 120 120" class="progress-ring">
            <circle cx="60" cy="60" r="54" class="progress-ring-bg"/>
            <circle cx="60" cy="60" r="54" class="progress-ring-circle" 
                    style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset}"/>
        </svg>
        <div class="circle-content">
    <div class="progress-text">${lesson.progress}%</div>
    <div class="char-count" style="font-size: 0.75rem;">${lesson.count}Â≠ó</div>
        </div>
            </div>
            <div class="circle-label">Lesson ${lesson.num}</div>
        </div>`;
                }
            }).join('');
              console.timeEnd('Rendering');  // ‚Üê Âä†ËøôË°å
        }
        
        // Toggle lesson selection
        function toggleLessonSelection(lessonId) {
            const card = document.querySelector(`[data-lesson="${lessonId}"]`);
            if (card.classList.contains('locked')) return;
            
            const isSelected = card.dataset.selected === 'true';
            card.dataset.selected = !isSelected;
            
            updateSelectedCount();
            updateLayer3Visibility();
        }
        
        // ==================== Update Layer 3 Visibility ====================
        function updateLayer3Visibility() {
            const selectedLessons = getSelectedLessons();
            const layer3 = document.getElementById('reviewMethodTabs');
            
            if (selectedLessons.length > 0) {
                // È°ØÁ§∫Â±§ 3 Tab
                layer3.style.display = 'block';
                
                // ÈáçË®≠ÁÇ∫ Smart ReviewÔºàÈ†êË®≠Ôºâ
                document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('#reviewMethodTabs .tab-btn[data-tab="smart-review"]').classList.add('active');
                
                // Âè™È°ØÁ§∫ Smart Review ÂÖßÂÆπ
                document.getElementById('recommendedSection').style.display = 'block';
                document.getElementById('difficultySection').style.display = 'none';
            } else {
                // Ê≤íÈÅ∏Ë™≤Á®ãÊôÇÈö±ËóèÂ±§ 3 ÂèäÂÖ∂ÂÖßÂÆπ
                layer3.style.display = 'none';
                document.getElementById('recommendedSection').style.display = 'none';
                document.getElementById('difficultySection').style.display = 'none';
            }
        }
        
        // Get selected lessons
        function getSelectedLessons() {
            const selected = [];
            document.querySelectorAll('.circle-card[data-selected="true"]').forEach(card => {
                selected.push(card.dataset.lesson);
            });
            return selected;
        }
        
        // ==================== Layer 1: Tab Switching (Components vs Characters vs Phrases) ====================
        document.querySelectorAll('.tab-system:first-of-type .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active from all Layer 1 buttons
                document.querySelectorAll('.tab-system:first-of-type .tab-btn').forEach(b => b.classList.remove('active'));
                // Add active to clicked button
                btn.classList.add('active');
                currentTab = btn.dataset.tab;
                
                // ÊòæÁ§∫/ÈöêËóèÂ§ç‰π†ÊñπÂêëÈÄâÊã©Âô®ÔºàÂè™Âú®ËØçÁªÑtabÊòæÁ§∫Ôºâ
                const directionSelector = document.getElementById('reviewDirectionSelector');
                if (directionSelector) {
                    directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
                }
                
                // Êõ¥Êñ∞due-infoÁöÑÊñáÂ≠ó
                updateDueInfoText();
                
                // Render and reset
                renderLessonCheckboxes();
                clearAllLessons();
                updateStats();
            });
        });
        
        // ==================== Update Due Info Text ====================
        function updateDueInfoText() {
            const dueItemType = document.getElementById('dueItemType');
            if (dueItemType) {
                if (currentTab === 'phrases') {
                    dueItemType.textContent = 'phrases';
                } else if (currentTab === 'components') {
                    dueItemType.textContent = 'components';
                } else {
                    dueItemType.textContent = 'characters';
                }
            }
        }
        

        


        // ==================== Select/Clear All Lessons ====================
        function selectAllLessons() {
            document.querySelectorAll('.circle-card:not(.locked)').forEach(card => {
                card.dataset.selected = 'true';
            });
            updateSelectedCount();
        }
        
        function clearAllLessons() {
            document.querySelectorAll('.circle-card').forEach(card => {
                card.dataset.selected = 'false';
            });
            updateSelectedCount();
            resetLayer3();
        }
        
        function updateSelectedCount() {
            const checked = document.querySelectorAll('.circle-card[data-selected="true"]').length;
            const total = document.querySelectorAll('.circle-card:not(.locked)').length;
            document.getElementById('selectedCount').textContent = `(${checked}/${total})`;
            updateStats();
        }
        
        // ==================== Get Selected Characters ====================
        function getSelectedCharacters() {
            const selectedLessons = getSelectedLessons();
            
            let sourceItems = [];
            if (currentTab === 'components') {
                sourceItems = componentCharacters;
            } else if (currentTab === 'characters') {
                sourceItems = targetCharacters;
            } else if (currentTab === 'phrases') {
                sourceItems = phraseItems;
            }
            
            return sourceItems.filter(item => selectedLessons.includes(item.lesson));
        }
        
        // ==================== Update Statistics ====================
        function updateStats() {
            const items = getSelectedCharacters();
            const boxes = { forgot: 0, hard: 0, good: 0, easy: 0 };
            
            items.forEach(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ‰ΩøÁî®uniqueId‰Ωú‰∏∫key
                    progress = userProgress[item.uniqueId];
                } else {
                    // ‰ΩøÁî®character‰Ωú‰∏∫key
                    progress = userProgress[item.character];
                }
                const box = progress ? progress.box : 'forgot';
                boxes[box]++;
            });
            
            document.getElementById('count-forgot').textContent = boxes.forgot;
            document.getElementById('count-hard').textContent = boxes.hard;
            document.getElementById('count-good').textContent = boxes.good;
            document.getElementById('count-easy').textContent = boxes.easy;
            
            // Update due count
            const dueItems = getDueCharacters(items);
            document.getElementById('totalDue').textContent = dueItems.length;
            
            updateRecommendedBreakdown();
        }
        
        // ==================== Get Due Characters ====================
        function getDueCharacters(items) {
            const today = new Date().setHours(0, 0, 0, 0);
            
            return items.filter(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ‰ΩøÁî®uniqueId‰Ωú‰∏∫key
                    progress = userProgress[item.uniqueId];
                } else {
                    // ‰ΩøÁî®character‰Ωú‰∏∫key
                    progress = userProgress[item.character];
                }
                
                if (!progress) return true; // New item
                
                const lastReviewed = progress.lastReviewed ? new Date(progress.lastReviewed).setHours(0, 0, 0, 0) : null;
                if (!lastReviewed) return true;
                
                const daysSince = Math.floor((today - lastReviewed) / (1000 * 60 * 60 * 24));
                
                switch (progress.box) {
                    case 'forgot': return daysSince >= 0; // Daily
                    case 'hard': return daysSince >= 1;
                    case 'good': return daysSince >= 3;
                    case 'easy': return daysSince >= 7;
                    default: return true;
                }
            });
        }
        
        // ==================== Update Recommended Breakdown ====================
        function updateRecommendedBreakdown() {
            const items = getSelectedCharacters();
            const dueItems = getDueCharacters(items);
            const amount = document.getElementById('reviewAmount').value;
            
            let selectedItems = dueItems;
            if (amount !== 'all') {
                selectedItems = dueItems.slice(0, parseInt(amount));
            }
            
            const breakdown = { forgot: 0, hard: 0, good: 0, easy: 0 };
            selectedItems.forEach(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ‰ΩøÁî®uniqueId‰Ωú‰∏∫key
                    progress = userProgress[item.uniqueId];
                } else {
                    // ‰ΩøÁî®character‰Ωú‰∏∫key
                    progress = userProgress[item.character];
                }
                const box = progress ? progress.box : 'forgot';
                breakdown[box]++;
            });
            
            document.getElementById('recommendedBreakdown').innerHTML = `
                <div class="breakdown-item" style="border-color: var(--forgot); color: var(--forgot);">
                    <span class="breakdown-count">${breakdown.forgot}</span>
                    <span class="breakdown-label">Forgotten</span>
                </div>
                <div class="breakdown-item" style="border-color: var(--hard); color: var(--hard);">
                    <span class="breakdown-count">${breakdown.hard}</span>
                    <span class="breakdown-label">Hard</span>
                </div>
                <div class="breakdown-item" style="border-color: var(--good); color: var(--good);">
                    <span class="breakdown-count">${breakdown.good}</span>
                    <span class="breakdown-label">Good</span>
                </div>
                <div class="breakdown-item" style="border-color: var(--easy); color: var(--easy);">
                    <span class="breakdown-count">${breakdown.easy}</span>
                    <span class="breakdown-label">Easy</span>
                </div>
            `;
        }
        
        document.getElementById('reviewAmount').addEventListener('change', updateRecommendedBreakdown);
        
        // ==================== Start Reviews ====================
        function startRecommendedReview() {
            const items = getSelectedCharacters();
            const dueItems = getDueCharacters(items);
            const amount = document.getElementById('reviewAmount').value;
            
            if (dueItems.length === 0) {
                const itemType = currentTab === 'phrases' ? 'ËØçÁªÑ' : 'Â≠ó';
                showMessage(`No ${itemType} are due for review!Ê≤°ÊúâÂà∞ÊúüÁöÑ${itemType}ÈúÄË¶ÅÂ§ç‰π†ÔºÅ`, 'info');
                return;
            }
            
            reviewQueue = amount === 'all' ? dueItems : dueItems.slice(0, parseInt(amount));
            shuffleArray(reviewQueue);
            startReview();
        }
        
        function startBoxReview(box) {
            const items = getSelectedCharacters();
            reviewQueue = items.filter(item => {
                let progress;
                if (currentTab === 'phrases') {
                    // ‰ΩøÁî®uniqueId‰Ωú‰∏∫key
                    progress = userProgress[item.uniqueId];
                } else {
                    // ‰ΩøÁî®character‰Ωú‰∏∫key
                    progress = userProgress[item.character];
                }
                return progress ? progress.box === box : box === 'forgot';
            });
            
            if (reviewQueue.length === 0) {
                const itemType = currentTab === 'phrases' ? 'ËØçÁªÑ' : 'Â≠ó';
                showMessage(`Ê≤°Êúâ ${box} ÈöæÂ∫¶ÁöÑ${itemType}ÔºÅ`, 'info');
                return;
            }
            
            shuffleArray(reviewQueue);
            startReview();
        }
        
        function startReview() {
            currentReviewIndex = 0;
            // Hide all controls during review
            document.querySelectorAll('.tab-system').forEach(tab => tab.style.display = 'none');
            document.querySelector('.lesson-selector').style.display = 'none';
            document.querySelector('.recommended-section').style.display = 'none';
            document.querySelector('#difficultySection').style.display = 'none';
            // ÈöêËóèÂ§ç‰π†ÊñπÂêëÈÄâÊã©Âô®ÔºàÂ§ç‰π†Êó∂‰∏çÈúÄË¶ÅÊòæÁ§∫Ôºâ
            const directionSelector = document.getElementById('reviewDirectionSelector');
            if (directionSelector) {
                directionSelector.style.display = 'none';
            }
            // Show review area
            document.getElementById('reviewArea').classList.remove('hidden');
            showCard();
        }
        
        function endReview() {
            document.getElementById('reviewArea').classList.add('hidden');
            document.querySelectorAll('.tab-system').forEach(tab => tab.style.display = 'block');
            document.querySelector('.lesson-selector').style.display = 'block';
            document.getElementById('reviewMethodTabs').style.display = 'block';
            
            // ÊòæÁ§∫Â§ç‰π†ÊñπÂêëÈÄâÊã©Âô®ÔºàÂ¶ÇÊûúÂú®ËØçÁªÑtabÔºâ
            const directionSelector = document.getElementById('reviewDirectionSelector');
            if (directionSelector && currentTab === 'phrases') {
                directionSelector.style.display = 'block';
            }
            
            // Reset to Smart Review tab
            document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#reviewMethodTabs .tab-btn[data-tab="smart-review"]').classList.add('active');
            document.getElementById('recommendedSection').style.display = 'block';
            document.getElementById('difficultySection').style.display = 'none';
            
            updateStats();
        }
        
        // ==================== Show Card ====================
        function showCard() {
            if (currentReviewIndex >= reviewQueue.length) {
                showCompletion();
                return;
            }
            
            const item = reviewQueue[currentReviewIndex];
            isCardFlipped = false;
            document.getElementById('card').classList.remove('flipped');
            
            // Ëé∑ÂèñÂ§ç‰π†ÊñπÂêë
            const direction = document.getElementById('reviewDirection') ? document.getElementById('reviewDirection').value : 'forward';
            reviewDirection = direction;
            
            const characterElement = document.getElementById('character');
            
            // Â¶ÇÊûúÊòØËØçÁªÑ
            if (currentTab === 'phrases') {
                if (direction === 'forward') {
                    // Ê≠£ÂêëÔºöÊ≠£Èù¢ÊòæÁ§∫Ê±âÂ≠óÔºåËÉåÈù¢ÊòæÁ§∫ÊãºÈü≥+Ëã±Êñá
                    characterElement.textContent = item.chinese;
                    document.getElementById('backCharacter').textContent = item.chinese;
                    document.getElementById('pinyin').textContent = item.pinyin;
                    document.getElementById('meaning').textContent = item.english;
                    // Ê±âÂ≠ó‰∏çÈúÄË¶ÅËã±ÊñáÊ†∑Âºè
                    characterElement.classList.remove('english-text');
                } else {
                    // ÂèçÂêëÔºöÊ≠£Èù¢ÊòæÁ§∫Ëã±ÊñáÔºåËÉåÈù¢ÊòæÁ§∫Ê±âÂ≠ó+ÊãºÈü≥
                    characterElement.textContent = item.english;
                    document.getElementById('backCharacter').textContent = item.chinese;
                    document.getElementById('pinyin').textContent = item.pinyin;
                    document.getElementById('meaning').textContent = item.chinese;
                    // Ëã±ÊñáÈúÄË¶ÅÁâπÊÆäÊ†∑ÂºèÔºàÊç¢Ë°å+ËæÉÂ∞èÂ≠ó‰ΩìÔºâ
                    characterElement.classList.add('english-text');
                    // Ê†πÊçÆËã±ÊñáÈïøÂ∫¶Âä®ÊÄÅË∞ÉÊï¥Â≠ó‰ΩìÂ§ßÂ∞è
                    adjustEnglishFontSize(characterElement, item.english);
                }
                
                // ÊòæÁ§∫‰æãÂè•ÔºàÂ¶ÇÊûúÊúâÔºâ
                const phraseExampleSection = document.getElementById('phraseExampleSection');
                const hasExample = item.notes || item.example_en || item.example_es;
                
                if (hasExample) {
                    let exampleHTML = '';
                    
                    // ‰∏≠Êñá‰æãÂè•
                    if (item.notes && item.notes.trim()) {
                        exampleHTML += `
                            <div class="phrase-example-item">
                                <div class="phrase-example-label" style="color: var(--character-color);">‰∏≠ÊñáÔºö</div>
                                <div class="phrase-example-text">${parseSimpleMarkdown(item.notes)}</div>
                            </div>
                        `;
                    }
                    
                    // Ëã±ÊñáÁøªËØë
                    if (item.example_en && item.example_en.trim()) {
                        exampleHTML += `
                            <div class="phrase-example-item">
                                <div class="phrase-example-label" style="color: var(--english-color);">English:</div>
                                <div class="phrase-example-text" style="color: var(--english-color);">${parseSimpleMarkdown(item.example_en)}</div>
                            </div>
                        `;
                    }
                    
                    // Ë•øÁè≠ÁâôËØ≠ÁøªËØë
                    if (item.example_es && item.example_es.trim()) {
                        exampleHTML += `
                            <div class="phrase-example-item">
                                <div class="phrase-example-label" style="color: var(--spanish-color);">Espa√±ol:</div>
                                <div class="phrase-example-text" style="color: var(--spanish-color);">${parseSimpleMarkdown(item.example_es)}</div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('phraseExampleContent').innerHTML = exampleHTML;
                    phraseExampleSection.classList.remove('hidden');
                } else {
                    phraseExampleSection.classList.add('hidden');
                }
                
                // ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂÖÉÁ¥†
                document.getElementById('cardImage').classList.add('hidden');
                document.getElementById('cardBookExplanation').classList.add('hidden');
                document.getElementById('cardStory').classList.add('hidden');
                document.getElementById('cardPhrases').classList.add('hidden');
            } else {
                // Â≠óÁ¨¶ÔºàÈÉ®‰ª∂ÊàñÁõÆÊ†áÂ≠óÔºâ
                characterElement.textContent = item.character;
                document.getElementById('backCharacter').textContent = item.character;
                document.getElementById('pinyin').textContent = item.pinyin;
                document.getElementById('meaning').textContent = item.meaning;
                // Â≠óÁ¨¶‰∏çÈúÄË¶ÅËã±ÊñáÊ†∑Âºè
                characterElement.classList.remove('english-text');
                
                // ÈöêËóèËØçÁªÑ‰æãÂè•Âå∫Âüü
                document.getElementById('phraseExampleSection').classList.add('hidden');
                
                // Image
                const cardImage = document.getElementById('cardImage');
                if (item.image) {
                    cardImage.src = item.image;
                    cardImage.classList.remove('hidden');
                } else {
                    cardImage.classList.add('hidden');
                }
                
                // Book Explanation
                const cardBookExplanation = document.getElementById('cardBookExplanation');
                if (item.book_explanation && item.book_explanation.trim()) {
                    const processedExplanation = processMarkdownImages(marked.parse(item.book_explanation));
                    document.getElementById('bookExplanationContent').innerHTML = processedExplanation;
                    cardBookExplanation.classList.remove('hidden');
                } else {
                    cardBookExplanation.classList.add('hidden');
                }
                
                // Story
                const cardStory = document.getElementById('cardStory');
                if (item.story && item.story.trim()) {
                    const processedStory = processMarkdownImages(marked.parse(item.story));
                    document.getElementById('storyContent').innerHTML = processedStory;
                    cardStory.classList.remove('hidden');
                } else {
                    cardStory.classList.add('hidden');
                }
                
                // Phrases (for characters)
                const cardPhrases = document.getElementById('cardPhrases');
                if (item.phrases && item.phrases.trim()) {
                    const processedPhrases = processMarkdownImages(marked.parse(item.phrases));
                    document.getElementById('phrasesContent').innerHTML = processedPhrases;
                    cardPhrases.classList.remove('hidden');
                } else {
                    cardPhrases.classList.add('hidden');
                }
            }
            
            // Update progress
            updateProgress();
        }
        
        // ==================== Adjust English Font Size ====================
        function adjustEnglishFontSize(element, englishText) {
            if (!element || !englishText) return;
            
            const textLength = englishText.length;
            let fontSize;
            
            // Ê†πÊçÆËã±ÊñáÈïøÂ∫¶Âä®ÊÄÅË∞ÉÊï¥Â≠ó‰ΩìÂ§ßÂ∞è
            if (textLength <= 10) {
                // Áü≠ÂçïËØçÔºöËæÉÂ§ßÂ≠ó‰Ωì
                fontSize = window.innerWidth <= 640 ? 'clamp(32px, 7vw, 60px)' : 'clamp(50px, 8vw, 80px)';
            } else if (textLength <= 20) {
                // ‰∏≠Á≠âÈïøÂ∫¶Ôºö‰∏≠Á≠âÂ≠ó‰Ωì
                fontSize = window.innerWidth <= 640 ? 'clamp(24px, 5vw, 45px)' : 'clamp(35px, 6vw, 60px)';
            } else {
                // ÈïøÂçïËØçÔºöËæÉÂ∞èÂ≠ó‰Ωì
                fontSize = window.innerWidth <= 640 ? 'clamp(18px, 4vw, 35px)' : 'clamp(28px, 5vw, 50px)';
            }
            
            element.style.fontSize = fontSize;
        }
        
        // ==================== Card Flip ====================
        document.getElementById('card').addEventListener('click', (e) => {
            if (e.target.classList.contains('speak-btn')) return;
            document.getElementById('card').classList.toggle('flipped');
        });
        
        // ==================== Handle Card Move ====================
        async function handleCardMove(box) {
            const item = reviewQueue[currentReviewIndex];
            
            // Á°ÆÂÆö‰ΩøÁî®ÁöÑkey
            let progressKey;
            if (currentTab === 'phrases') {
                progressKey = item.uniqueId;
            } else {
                progressKey = item.character;
            }
            
            // Update progress
            userProgress[progressKey] = {
                character: currentTab === 'phrases' ? item.chinese : item.character,
                lesson: item.lesson,
                box: box,
                reviews: (userProgress[progressKey]?.reviews || 0) + 1,
                lastReviewed: new Date().toISOString()
            };
            
            // Ê®ôË®òÊúâÂæÖ‰øùÂ≠òÁöÑÊõ¥Êîπ
            pendingSave = true;
            
            // ‰ΩøÁî®Èò≤ÊäñÊ©üÂà∂ÔºöÂè™Âú®3ÁßíÂÖßÊ≤íÊúâÊñ∞Êìç‰ΩúÊôÇÊâç‰øùÂ≠ò
            // ÈÄôÊ®£ÂèØ‰ª•Â§ßÂπÖÊ∏õÂ∞ëFirebaseÂØ´ÂÖ•Ê¨°Êï∏
            if (saveProgressTimeout) {
                clearTimeout(saveProgressTimeout);
            }
            saveProgressTimeout = setTimeout(() => {
                if (pendingSave) {
                    saveUserProgress();
                    pendingSave = false;
                }
            }, 3000); // 3ÁßíÈò≤ÊäñÂª∂ÈÅ≤
            
            // Next card
            currentReviewIndex++;
            showCard();
        }
        
        // ==================== Update Progress Bar ====================
        function updateProgress() {
            const total = reviewQueue.length;
            const current = currentReviewIndex;
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('progressText').textContent = `${current}/${total} Â∑≤Â§ç‰π†`;
        }
        
        // ==================== Show Completion ====================
        async function showCompletion() {
            // Á¢∫‰øùÂú®ÂÆåÊàêÊôÇ‰øùÂ≠òÊâÄÊúâÂæÖ‰øùÂ≠òÁöÑÈÄ≤Â∫¶
            if (saveProgressTimeout) {
                clearTimeout(saveProgressTimeout);
            }
            if (pendingSave) {
                await saveUserProgress();
                pendingSave = false;
            }
            
            document.getElementById('reviewArea').classList.add('hidden');
            const msg = document.getElementById('completionMessage');
            
            // ÊîπÊàêÈ°ØÁ§∫ÂÆåÊàêË®äÊÅØ + ÊåâÈàïÔºå‰∏çË¶ÅËá™ÂãïË∑≥Âõû
            msg.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">üéâ</div>
                    <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 8px;">Great job!</div>
                    <div style="font-size: 1rem; margin-bottom: 24px;">You've reviewed ${reviewQueue.length} ${currentTab === 'phrases' ? 'phrases' : 'characters'}</div>
                    <button class="btn btn-primary" onclick="returnToReviewHome()" style="padding: 14px 32px; font-size: 1rem;">
                        ‚Üê Back to Review Home
                    </button>
                </div>
            `;
            msg.className = 'message success';
            msg.classList.remove('hidden');
        }
        
        // ==================== Return to Review Home ====================
        function returnToReviewHome() {
            document.getElementById('completionMessage').classList.add('hidden');
            endReview();
        }
        
        function speakPinyin(event) {
            event.stopPropagation();
            let textToSpeak;
            
            if (currentTab === 'phrases') {
                // ËØçÁªÑÔºöÂèëÈü≥Ê±âÂ≠óÈÉ®ÂàÜ
                textToSpeak = document.getElementById('backCharacter').textContent;
            } else {
                // Â≠óÁ¨¶ÔºöÂèëÈü≥Â≠óÁ¨¶
                textToSpeak = document.getElementById('backCharacter').textContent;
            }
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            // Âº∫Âà∂‰ΩøÁî®‰∏≠ÊñáÂ£∞Èü≥
            const voices = speechSynthesis.getVoices();
            const chineseVoice = voices.find(v => v.lang.includes('zh'));
            if (chineseVoice) utterance.voice = chineseVoice;
            
            utterance.lang = 'zh-CN';
            utterance.rate = 0.8;
            speechSynthesis.speak(utterance);
        }
        
        // ==================== Process Markdown Images ====================
        function processMarkdownImages(html) {
            // Parse HTML and add classes based on alt text
            const div = document.createElement('div');
            div.innerHTML = html;
            
            const images = div.querySelectorAll('img');
            images.forEach(img => {
                const alt = img.getAttribute('alt') || '';
                
                if (alt === 'comp') {
                    img.classList.add('img-comp');
                } else if (alt === 'origin') {
                    img.classList.add('img-origin');
                } else if (alt === 'story') {
                    img.classList.add('img-story');
                }
            });
            
            return div.innerHTML;
        }
        
        // ==================== User Progress (Firebase) ====================
        async function loadUserProgress() {
            if (!username) {
                console.warn('Cannot load progress: username not set');
                return;
            }
            
            try {
                // ‰ΩøÁî®Áî®Êà∑Âêç‰Ωú‰∏∫ÊñáÊ°£ID
                const doc = await db.collection('user_progress').doc(username).get();
                if (doc.exists) {
                    const data = doc.data();
                    userProgress = data.characterProgress || {};
                    studentName = data.studentName || '';
                } else {
                    // Êñ∞Áî®Êà∑ÔºåÂàùÂßãÂåñ‰∏∫Á©∫
                    userProgress = {};
                    studentName = '';
                }
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }
        
        async function saveUserProgress() {
            if (!username) {
                console.warn('Cannot save progress: username not verified');
                return;
            }
            
            try {
                // ‰ΩøÁî®Áî®Êà∑Âêç‰Ωú‰∏∫ÊñáÊ°£ID
                await db.collection('user_progress').doc(username).set({
                    characterProgress: userProgress,
                    lastReview: new Date().toISOString(),
                    deviceCode: deviceCode,
                    studentName: studentName,
                    username: username,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // ‰ΩøÁî® merge ÂèØ‰ª•Ê∏õÂ∞ëÂØ´ÂÖ•ÊàêÊú¨
                console.log('‚úÖ Progress saved to Firebase');
            } catch (error) {
                console.error('‚ùå Error saving progress:', error);
            }
        }
        
        // ==================== Import/Export ====================
        function exportProgress() {
            // ÂØºÂá∫ÂÆåÊï¥Ê†ºÂºèÔºåÂåÖÂê´ÊâÄÊúâÂ≠óÊÆµ
            const data = {
                exportDate: new Date().toISOString(),
                exportType: 'single_student',
                student: {
                    deviceCode: deviceCode || '------',
                    studentName: studentName || '',
                    lastReview: new Date().toISOString(),
                    characterProgress: userProgress
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = `shizi-progress-${deviceCode || 'student'}-${new Date().toISOString().split('T')[0]}.json`;
            a.download = fileName;
            a.click();
            
            showMessage('‚úÖ ËµÑÊñôÂ∑≤ÂØºÂá∫ÔºÅ', 'success');
        }
        
        document.getElementById('importFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                showMessage('Ê≠£Âú®ÂØºÂÖ•Êï∞ÊçÆ...', 'info');
                const text = await file.text();
                const data = JSON.parse(text);
                
                let progressToImport = null;
                
                // ÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºö
                // 1. ‰ªé admin ÂØºÂá∫ÁöÑÂÆåÊï¥Ê†ºÂºèÔºàÂçï‰∏™Â≠¶ÁîüÊàñÊâÄÊúâÂ≠¶ÁîüÔºâ
                if (data.exportType === 'single_student' && data.student) {
                    progressToImport = data.student.characterProgress || {};
                } else if (data.exportType === 'all_students' && data.students && data.students.length > 0) {
                    // Â¶ÇÊûúÊòØÂ§ö‰∏™Â≠¶ÁîüÔºåËÆ©Áî®Êà∑ÈÄâÊã©Êàñ‰ΩøÁî®Á¨¨‰∏Ä‰∏™
                    if (data.students.length === 1) {
                        progressToImport = data.students[0].characterProgress || {};
                    } else {
                        // Â§ö‰∏™Â≠¶ÁîüÊó∂ÔºåÂ∞ùËØïÂåπÈÖçÂΩìÂâçËÆæÂ§áÁ†Å
                        const currentCode = deviceCode || '';
                        const matched = data.students.find(s => 
                            s.deviceCode && s.deviceCode.toUpperCase() === currentCode.toUpperCase()
                        );
                        if (matched) {
                            progressToImport = matched.characterProgress || {};
                        } else {
                            // Ê≤°ÊúâÂåπÈÖçÁöÑÔºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™
                            progressToImport = data.students[0].characterProgress || {};
                            showMessage(`‚ö†Ô∏è Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËÆæÂ§áÁ†ÅÔºåÂ∑≤ÂØºÂÖ•Á¨¨‰∏Ä‰∏™Â≠¶ÁîüÁöÑËµÑÊñôÔºà${data.students[0].deviceCode}Ôºâ`, 'warning');
                        }
                    }
                } 
                // 2. ‰ªéÂ≠¶ÁîüÁ´ØÂØºÂá∫ÁöÑÁÆÄÂçïÊ†ºÂºè
                else if (data.characterProgress) {
                    progressToImport = data.characterProgress;
                }
                // 3. Áõ¥Êé•ÊòØ characterProgress ÂØπË±°
                else if (typeof data === 'object' && !data.exportType) {
                    // Ê£ÄÊü•ÊòØÂê¶Áõ¥Êé•ÊòØËøõÂ∫¶ÂØπË±°
                    const hasCharacterFields = Object.values(data).some(v => 
                        v && typeof v === 'object' && (v.character || v.box || v.reviews !== undefined)
                    );
                    if (hasCharacterFields) {
                        progressToImport = data;
                    }
                }
                
                if (!progressToImport || Object.keys(progressToImport).length === 0) {
                    showMessage('‚ùå Êó†Ê≥ïËØÜÂà´Êñá‰ª∂Ê†ºÂºèÔºÅËØ∑Á°ÆËÆ§ËøôÊòØ‰ªéÊú¨Á≥ªÁªüÂØºÂá∫ÁöÑ JSON Êñá‰ª∂„ÄÇ', 'error');
                    return;
                }
                
                // ÂêàÂπ∂Ê®°ÂºèÔºö‰øùÁïô‰∏§‰∏™ËÆæÂ§á‰∏≠Êõ¥Â•ΩÁöÑÂ≠¶‰π†ËÆ∞ÂΩï
                const beforeCount = Object.keys(userProgress).length;
                userProgress = mergeProgress(userProgress, progressToImport);
                const afterCount = Object.keys(userProgress).length;
                const addedCount = afterCount - beforeCount;
                
                await saveUserProgress();
                
                const message = addedCount > 0
                    ? `‚úÖ ÂØºÂÖ•ÊàêÂäüÔºÅÂêàÂπ∂‰∫Ü ${addedCount} ‰∏™Êñ∞Â≠óÁöÑÂ≠¶‰π†ËÆ∞ÂΩï„ÄÇ`
                    : '‚úÖ ÂØºÂÖ•ÊàêÂäüÔºÅÂ∑≤‰øùÁïôÊÇ®ÂΩìÂâçËÆæÂ§á‰∏≠Êõ¥Â•ΩÁöÑÂ≠¶‰π†ËÆ∞ÂΩï„ÄÇ';
                showMessage(message, 'success');
                updateStats();
                
                // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•ÔºåÂÖÅËÆ∏ÈáçÂ§çÂØºÂÖ•Âêå‰∏ÄÊñá‰ª∂
                e.target.value = '';
            } catch (error) {
                console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                showMessage('‚ùå ÂØºÂÖ•Â§±Ë¥•: ' + error.message, 'error');
            }
        });
        
        // ==================== Device Code Sync ====================
        function showDeviceCodeInput() {
            const code = prompt('Enter device code from another device (6 digits):');
            if (!code) return;
            
            syncFromDeviceCode(code.toUpperCase());
        }
        
        // ==================== Merge Progress Helper ====================
        // ÂêàÂπ∂‰∏§‰∏™ËÆæÂ§áÁöÑËøõÂ∫¶Êï∞ÊçÆÔºàÊô∫ËÉΩÂêàÂπ∂Ôºå‰øùÁïôÊõ¥Â§öÂ≠¶‰π†ËÆ∞ÂΩïÔºâ
        function mergeProgress(currentProgress, newProgress) {
            const merged = { ...currentProgress };
            const boxPriority = { 'forgot': 0, 'hard': 1, 'good': 2, 'easy': 3 };
            
            // ÈÅçÂéÜÊñ∞ËÆæÂ§áÁöÑÊâÄÊúâÂ≠ó
            Object.keys(newProgress).forEach(char => {
                const newChar = newProgress[char];
                const currentChar = merged[char];
                
                if (!currentChar) {
                    // ÂΩìÂâçËÆæÂ§áÊ≤°ÊúâËøô‰∏™Â≠óÔºåÁõ¥Êé•Ê∑ªÂä†
                    merged[char] = { ...newChar };
                } else {
                    // ‰∏§‰∏™ËÆæÂ§áÈÉΩÊúâËøô‰∏™Â≠óÔºåÈÄâÊã©‰øùÁïôÊõ¥Â•ΩÁöÑËÆ∞ÂΩï
                    const newReviews = newChar.reviews || 0;
                    const currentReviews = currentChar.reviews || 0;
                    
                    // ‰ºòÂÖà‰øùÁïôÂ§ç‰π†Ê¨°Êï∞Êõ¥Â§öÁöÑ
                    if (newReviews > currentReviews) {
                        merged[char] = { ...newChar };
                    } else if (newReviews === currentReviews) {
                        // Â¶ÇÊûúÊ¨°Êï∞Áõ∏ÂêåÔºå‰øùÁïôËÆ∞ÂøÜÁõíÁ≠âÁ∫ßÊõ¥È´òÁöÑ
                        const newBoxPriority = boxPriority[newChar.box] || 0;
                        const currentBoxPriority = boxPriority[currentChar.box] || 0;
                        if (newBoxPriority > currentBoxPriority) {
                            merged[char] = { ...newChar };
                        }
                        // Âê¶Âàô‰øùÁïôÂΩìÂâçÁöÑÔºàÂ∑≤ÁªèÊòØÊõ¥Â•ΩÁöÑÔºâ
                    }
                    // Â¶ÇÊûúÂΩìÂâçËÆæÂ§áÁöÑÂ§ç‰π†Ê¨°Êï∞Êõ¥Â§öÔºå‰øùÁïôÂΩìÂâçÁöÑ
                }
            });
            
            return merged;
        }
        
        async function syncFromDeviceCode(code) {
            try {
                showMessage('Ê≠£Âú®ÂêåÊ≠•Êï∞ÊçÆ...', 'info');
                
                // Search for user with this device code
                const snapshot = await db.collection('user_progress')
                    .where('deviceCode', '==', code.toUpperCase())
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    showMessage('‚ùå Êâæ‰∏çÂà∞ËØ•ËÆæÂ§áÁ†ÅÔºÅËØ∑Á°ÆËÆ§ËÆæÂ§áÁ†ÅÊòØÂê¶Ê≠£Á°Æ„ÄÇ', 'error');
                    return;
                }
                
                const data = snapshot.docs[0].data();
                const remoteProgress = data.characterProgress || {};
                
                // ÂêàÂπ∂Ê®°ÂºèÔºö‰øùÁïô‰∏§‰∏™ËÆæÂ§á‰∏≠Êõ¥Â•ΩÁöÑÂ≠¶‰π†ËÆ∞ÂΩï
                const beforeCount = Object.keys(userProgress).length;
                userProgress = mergeProgress(userProgress, remoteProgress);
                const afterCount = Object.keys(userProgress).length;
                const addedCount = afterCount - beforeCount;
                
                // ‰øùÂ≠òÂêàÂπ∂ÂêéÁöÑÊï∞ÊçÆ
                await saveUserProgress();
                
                // ÊòæÁ§∫ÂêàÂπ∂ÁªìÊûú
                const message = addedCount > 0 
                    ? `‚úÖ ÂêåÊ≠•ÊàêÂäüÔºÅÂêàÂπ∂‰∫Ü ${addedCount} ‰∏™Êñ∞Â≠óÁöÑÂ≠¶‰π†ËÆ∞ÂΩï„ÄÇ`
                    : '‚úÖ ÂêåÊ≠•ÊàêÂäüÔºÅÂ∑≤‰øùÁïôÊÇ®ÂΩìÂâçËÆæÂ§á‰∏≠Êõ¥Â•ΩÁöÑÂ≠¶‰π†ËÆ∞ÂΩï„ÄÇ';
                showMessage(message, 'success');
                updateStats();
            } catch (error) {
                console.error('ÂêåÊ≠•Â§±Ë¥•:', error);
                showMessage('‚ùå ÂêåÊ≠•Â§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        // ==================== Utilities ====================
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function showMessage(text, type = 'info') {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            document.querySelector('.container').appendChild(msg);
            
            setTimeout(() => msg.remove(), 4000);
        }

        // ========== Âä†ËøôÊÆµÔºàÂà∑Êñ∞Êï∞ÊçÆÂäüËÉΩÔºâ==========
            function refreshData() {
                if (confirm('üîÑ This will reload fresh data from the server. Continue?\n\nËøôÂ∞ÜÈáçÊñ∞Âä†ËΩΩÊúÄÊñ∞Êï∞ÊçÆÔºåÁ°ÆÂÆöÂêóÔºü')) {
                    localStorage.removeItem('lessons_cache');
                    location.reload();
                }
            }
            // ========== Âà∞ËøôÈáå ==========
            
// ==================== Layer 3: Tab Switching (Smart Review vs By Difficulty) ====================
document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const tab = e.target.dataset.tab;
        
        // Remove active from all Layer 3 buttons
        document.querySelectorAll('#reviewMethodTabs .tab-btn').forEach(b => {
            b.classList.remove('active');
        });
        
        // Add active to clicked button
        e.target.classList.add('active');
        
        // Hide all content first
        document.getElementById('recommendedSection').style.display = 'none';
        document.getElementById('difficultySection').style.display = 'none';
        
        // ÊòæÁ§∫/ÈöêËóèÂ§ç‰π†ÊñπÂêëÈÄâÊã©Âô®ÔºàÂè™Âú®ËØçÁªÑtabÊòæÁ§∫Ôºâ
        const directionSelector = document.getElementById('reviewDirectionSelector');
        if (directionSelector) {
            directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
        }
        
        // Show selected content
        if (tab === 'smart-review') {
            document.getElementById('recommendedSection').style.display = 'block';
        } else if (tab === 'by-difficulty') {
            document.getElementById('difficultySection').style.display = 'block';
        }
    });
});

// È†ÅÈù¢ËºâÂÖ•ÊôÇÔºåÈ†êË®≠È°ØÁ§∫ Smart ReviewÔºà‰ΩÜÂ±§ 3 Tab ÊáâË©≤Èö±ËóèÔºåÈô§ÈùûÂ±§ 2 ÊúâÈÅ∏Ë™≤Á®ãÔºâ
window.addEventListener('load', () => {
    document.getElementById('reviewMethodTabs').style.display = 'none';
    document.getElementById('recommendedSection').style.display = 'none';
    document.getElementById('difficultySection').style.display = 'none';
});

// ==================== Username Verification ====================
async function checkAndVerifyUsername() {
    // ‰ªé localStorage ËØªÂèñ‰øùÂ≠òÁöÑÁî®Êà∑Âêç
    const savedUsername = localStorage.getItem('shizi_username');
    
    if (savedUsername) {
        // Ëá™Âä®È™åËØÅ‰øùÂ≠òÁöÑÁî®Êà∑Âêç
        const isValid = await verifyUsername(savedUsername);
        if (isValid) {
            username = savedUsername;
            return; // È™åËØÅÈÄöËøáÔºåÁªßÁª≠
        } else {
            // È™åËØÅÂ§±Ë¥•ÔºåÊ∏ÖÈô§‰øùÂ≠òÁöÑÁî®Êà∑Âêç
            localStorage.removeItem('shizi_username');
            showUsernameModal('ËØ•Áî®Êà∑ÂêçÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•');
        }
    } else {
        // Ê≤°Êúâ‰øùÂ≠òÁöÑÁî®Êà∑ÂêçÔºåÊòæÁ§∫ËæìÂÖ•Ê°Ü
        showUsernameModal();
    }
}

function showUsernameModal(errorMsg = '') {
    const modal = document.getElementById('usernameModal');
    const input = document.getElementById('usernameInput');
    const errorDiv = document.getElementById('usernameError');
    
    // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÁî®Êà∑ÂêçÔºåËá™Âä®Â°´ÂÖÖ
    const savedUsername = localStorage.getItem('shizi_username');
    if (savedUsername) {
        input.value = savedUsername;
    }
    
    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
    if (errorMsg) {
        errorDiv.textContent = '‚ùå ' + errorMsg;
        errorDiv.style.display = 'block';
    } else {
        errorDiv.style.display = 'none';
    }
    
    modal.style.display = 'flex';
    input.focus();
    
    // ÂÖÅËÆ∏ Enter ÈîÆÊèê‰∫§
    input.onkeypress = (e) => {
        if (e.key === 'Enter') {
            verifyAndSaveUsername();
        }
    };
}

async function verifyAndSaveUsername() {
    const input = document.getElementById('usernameInput');
    const errorDiv = document.getElementById('usernameError');
    const usernameValue = input.value.trim().toLowerCase();
    
    // Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ
    errorDiv.style.display = 'none';
    
    if (!usernameValue) {
        errorDiv.textContent = '‚ùå Please enter a username!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Ê£ÄÊü•Ê†ºÂºèÔºàÂè™ÂÖÅËÆ∏Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÔºâ
    if (!/^[a-z0-9_]+$/.test(usernameValue)) {
        errorDiv.textContent = '‚ùå Username can only contain lowercase letters, numbers, and underscores!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // ÊòæÁ§∫È™åËØÅ‰∏≠
    errorDiv.textContent = '‚è≥ Verifying...';
    errorDiv.style.color = 'var(--primary-color)';
    errorDiv.style.display = 'block';
    
    try {
        // È™åËØÅÁî®Êà∑ÂêçÊòØÂê¶Âú®ÁôΩÂêçÂçï‰∏≠
        const isValid = await verifyUsername(usernameValue);
        
        if (isValid) {
            // È™åËØÅÈÄöËøá
            username = usernameValue;
            localStorage.setItem('shizi_username', usernameValue);
            
            // ÂÖ≥Èó≠Áî®Êà∑Âêç Modal
            document.getElementById('usernameModal').style.display = 'none';
            input.value = '';
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâËØ•Áî®Êà∑ÂêçÁöÑËÆ∞ÂΩï
            const existingDoc = await db.collection('user_progress').doc(username).get();
            
            if (!existingDoc.exists) {
                // Êñ∞Áî®Êà∑ÔºåËØ¢ÈóÆÊòØÂê¶Ë¶ÅÂØºÂÖ•ÊóßÊï∞ÊçÆ
                showMigrationModal();
            } else {
                // Â∑≤ÊúâËÆ∞ÂΩïÔºåÁõ¥Êé•Âä†ËΩΩ
                await loadLessonsFromFirebase();
                await loadUserProgress();
                updateStudentNameDisplay();
                renderLessonCheckboxes();
                document.getElementById('loadingContainer').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                updateDueInfoText();
                const directionSelector = document.getElementById('reviewDirectionSelector');
                if (directionSelector) {
                    directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
                }
                updateStats();
                updateDeviceCodeDisplay();
                checkAndShowNameModal();
                
                showMessage('‚úÖ Username verified successfully!', 'success');
            }
        } else {
            // È™åËØÅÂ§±Ë¥•
            errorDiv.textContent = '‚ùå This username is not in the allowed list. Please contact your teacher!';
            errorDiv.style.color = 'var(--danger-color)';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('È™åËØÅÁî®Êà∑ÂêçÂ§±Ë¥•:', error);
        errorDiv.textContent = '‚ùå Verification failed: ' + error.message;
        errorDiv.style.color = 'var(--danger-color)';
        errorDiv.style.display = 'block';
    }
}

async function verifyUsername(usernameToCheck) {
    try {
        const doc = await db.collection('allowed_users').doc(usernameToCheck).get();
        
        if (!doc.exists) {
            return false; // Áî®Êà∑Âêç‰∏çÂ≠òÂú®
        }
        
        const data = doc.data();
        if (data.isActive === false) {
            return false; // Áî®Êà∑ÂêçÂ∑≤ÂÅúÁî®
        }
        
        return true; // È™åËØÅÈÄöËøá
    } catch (error) {
        console.error('È™åËØÅÁî®Êà∑ÂêçÊó∂Âá∫Èîô:', error);
        return false;
    }
}

// ==================== Data Migration ====================
function showMigrationModal() {
    const modal = document.getElementById('migrationModal');
    const input = document.getElementById('migrationDeviceCode');
    const errorDiv = document.getElementById('migrationError');
    
    errorDiv.style.display = 'none';
    modal.style.display = 'flex';
    input.value = '';
    input.focus();
    
    // ÂÖÅËÆ∏ Enter ÈîÆÊèê‰∫§
    input.onkeypress = (e) => {
        if (e.key === 'Enter') {
            migrateFromDeviceCode();
        }
    };
}

function skipMigration() {
    // Ë∑≥ËøáËøÅÁßªÔºåÂàõÂª∫Êñ∞ËÆ∞ÂΩï
    document.getElementById('migrationModal').style.display = 'none';
    initializeAfterMigration();
}

async function migrateFromDeviceCode() {
    const input = document.getElementById('migrationDeviceCode');
    const errorDiv = document.getElementById('migrationError');
    const deviceCodeValue = input.value.trim().toUpperCase();
    
    // Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ
    errorDiv.style.display = 'none';
    
    if (!deviceCodeValue) {
        errorDiv.textContent = '‚ùå ËØ∑ËæìÂÖ•ËÆæÂ§áÁ†ÅÔºÅ';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (deviceCodeValue.length !== 6) {
        errorDiv.textContent = '‚ùå ËÆæÂ§áÁ†ÅÂ∫î‰∏∫6‰ΩçÔºÅ';
        errorDiv.style.display = 'block';
        return;
    }
    
    // ÊòæÁ§∫Êü•Êâæ‰∏≠
    errorDiv.textContent = '‚è≥ Ê≠£Âú®Êü•ÊâæËÆæÂ§áËÆ∞ÂΩï...';
    errorDiv.style.color = 'var(--primary-color)';
    errorDiv.style.display = 'block';
    
    try {
        // Êü•ÊâæËØ• deviceCode ÁöÑÊâÄÊúâËÆ∞ÂΩï
        const snapshot = await db.collection('user_progress')
            .where('deviceCode', '==', deviceCodeValue)
            .get();
        
        if (snapshot.empty) {
            errorDiv.textContent = '‚ùå Êâæ‰∏çÂà∞ËØ•ËÆæÂ§áÁ†ÅÁöÑËÆ∞ÂΩïÔºÅËØ∑Á°ÆËÆ§ËÆæÂ§áÁ†ÅÊòØÂê¶Ê≠£Á°ÆÔºåÊàñÈÄâÊã©"Ë∑≥Ëøá"ÂàõÂª∫Êñ∞ËÆ∞ÂΩï„ÄÇ';
            errorDiv.style.color = 'var(--danger-color)';
            errorDiv.style.display = 'block';
            return;
        }
        
        // ÊâæÂà∞ËÆ∞ÂΩïÔºåÈÄâÊã©Á¨¨‰∏Ä‰∏™ÔºàÂ¶ÇÊûúÊúâÂ§ö‰∏™Ôºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™Ôºâ
        const oldDoc = snapshot.docs[0];
        const oldData = oldDoc.data();
        const oldUserId = oldDoc.id;
        
        // ÂêàÂπ∂ËøõÂ∫¶Êï∞ÊçÆÔºà‰ΩøÁî®‰πãÂâçÁöÑÂêàÂπ∂ÈÄªËæëÔºâ
        const oldProgress = oldData.characterProgress || {};
        userProgress = mergeProgress(userProgress, oldProgress);
        
        // Â¶ÇÊûúÊúâÂ≠¶ÁîüÂßìÂêçÔºå‰πü‰øùÁïô
        if (oldData.studentName && !studentName) {
            studentName = oldData.studentName;
        }
        
        // ‰øùÂ≠òÂà∞Êñ∞‰ΩçÁΩÆÔºà‰ΩøÁî®Áî®Êà∑Âêç‰Ωú‰∏∫ÊñáÊ°£IDÔºâ
        await db.collection('user_progress').doc(username).set({
            characterProgress: userProgress,
            lastReview: oldData.lastReview || new Date().toISOString(),
            deviceCode: deviceCode,
            studentName: studentName,
            username: username,
            migratedFrom: oldUserId, // ËÆ∞ÂΩïËøÅÁßªÊù•Ê∫ê
            migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Ê†áËÆ∞ÊóßËÆ∞ÂΩï‰∏∫Â∑≤ËøÅÁßª
        await db.collection('user_progress').doc(oldUserId).update({
            migratedTo: username,
            migratedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ÂÖ≥Èó≠ Modal
        document.getElementById('migrationModal').style.display = 'none';
        input.value = '';
        
        // ÂàùÂßãÂåñÈ°µÈù¢
        initializeAfterMigration();
        
        showMessage('‚úÖ Êï∞ÊçÆËøÅÁßªÊàêÂäüÔºÅÂ∑≤‰ªéÊóßËÆæÂ§áÂØºÂÖ•Â≠¶‰π†ËÆ∞ÂΩï„ÄÇ', 'success');
    } catch (error) {
        console.error('ËøÅÁßªÂ§±Ë¥•:', error);
        errorDiv.textContent = '‚ùå ËøÅÁßªÂ§±Ë¥•Ôºö' + error.message;
        errorDiv.style.color = 'var(--danger-color)';
        errorDiv.style.display = 'block';
    }
}

async function initializeAfterMigration() {
    // Âä†ËΩΩËØæÁ®ãÊï∞ÊçÆ
    await loadLessonsFromFirebase();
    await loadUserProgress();
    updateStudentNameDisplay();
    renderLessonCheckboxes();
    document.getElementById('loadingContainer').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    updateDueInfoText();
    const directionSelector = document.getElementById('reviewDirectionSelector');
    if (directionSelector) {
        directionSelector.style.display = currentTab === 'phrases' ? 'block' : 'none';
    }
    updateStats();
    updateDeviceCodeDisplay();
    checkAndShowNameModal();
    
    showMessage('‚úÖ Áî®Êà∑ÂêçÈ™åËØÅÊàêÂäüÔºÅ', 'success');
}

// ==================== Display Updates ====================
function updateDeviceCodeDisplay() {
    const deviceCodeElement = document.getElementById('deviceCode');
    if (deviceCodeElement) {
        if (username) {
            deviceCodeElement.textContent = `${deviceCode} (${username})`;
        } else {
            deviceCodeElement.textContent = deviceCode;
        }
    }
}

// ==================== Student Name Management ====================
function updateStudentNameDisplay() {
    const displayElement = document.getElementById('studentNameDisplay');
    const btnTextElement = document.getElementById('editNameBtnText');

    if (studentName && studentName.trim() !== '') {
        displayElement.textContent = studentName;
        if (btnTextElement) btnTextElement.textContent = 'Edit Name';
    } else {
        displayElement.textContent = 'Not set';
        if (btnTextElement) btnTextElement.textContent = 'Set Name';
    }
    
    // ÂêåÊó∂Êõ¥Êñ∞ deviceCode ÊòæÁ§∫ÔºàÂåÖÂê´Áî®Êà∑ÂêçÔºâ
    updateDeviceCodeDisplay();
}

function checkAndShowNameModal() {
    // Show modal if student name is not set
    if (!studentName || studentName.trim() === '') {
        const modal = document.getElementById('nameModal');
        modal.style.display = 'flex';
    }
}

function editStudentName() {
    const modal = document.getElementById('nameModal');
    const input = document.getElementById('studentNameInput');
    input.value = studentName || '';
    modal.style.display = 'flex';
    input.focus();
}

async function saveStudentName() {
    const input = document.getElementById('studentNameInput');
    const name = input.value.trim();

    if (name) {
        studentName = name;
        await saveUserProgress();
        updateStudentNameDisplay();
        showMessage('Name saved successfully!', 'success');
    }

    closeNameModal();
}

function skipNameInput() {
    closeNameModal();
}

function closeNameModal() {
    const modal = document.getElementById('nameModal');
    modal.style.display = 'none';
    document.getElementById('studentNameInput').value = '';
}

// Allow Enter key to submit name
document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('studentNameInput');
    if (input) {
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveStudentName();
            }
        });
    }
});

    </script>
    <script src="../../assets/js/nav-global.js"></script>
</body>
</html>